---
phase: 02-contribution-tracking
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - apps/web/lib/contributions/tree.ts
  - apps/web/app/api/contributions/[wallet]/route.ts
  - apps/web/app/api/contributions/route.ts
  - apps/web/components/contributions/contribution-list.tsx
  - apps/web/components/contributions/contribution-card.tsx
  - apps/web/components/contributions/score-badge.tsx
  - apps/web/app/(public)/profile/[wallet]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their complete contribution history on their profile page with task reference, score, timestamp, and verification status"
    - "Contribution score badge displays the calculated score with breakdown (tasks, avg score, time active)"
    - "Anyone visiting a developer's profile page can see their contributions and score without authentication"
    - "Contribution list shows most recent contributions first with pagination"
    - "Each contribution card shows content hash for on-chain verification with link to Solana Explorer transaction"
  artifacts:
    - path: "apps/web/app/api/contributions/[wallet]/route.ts"
      provides: "GET endpoint for contributions by wallet with pagination"
      exports: ["GET"]
    - path: "apps/web/app/api/contributions/route.ts"
      provides: "GET endpoint for recent contributions across all developers"
      exports: ["GET"]
    - path: "apps/web/components/contributions/contribution-list.tsx"
      provides: "Paginated contribution history component"
    - path: "apps/web/components/contributions/contribution-card.tsx"
      provides: "Single contribution display with verification info"
    - path: "apps/web/components/contributions/score-badge.tsx"
      provides: "Contribution score display with breakdown tooltip"
    - path: "apps/web/lib/contributions/tree.ts"
      provides: "TypeScript client helpers for Merkle tree operations"
      exports: ["createContributionTree", "getTreeConfig"]
    - path: "apps/web/app/(public)/profile/[wallet]/page.tsx"
      provides: "Updated profile page with contribution history and score"
  key_links:
    - from: "apps/web/app/(public)/profile/[wallet]/page.tsx"
      to: "apps/web/app/api/contributions/[wallet]/route.ts"
      via: "Server-side Prisma query (SSR) or client fetch"
      pattern: "prisma\\.contribution\\.findMany"
    - from: "apps/web/components/contributions/contribution-card.tsx"
      to: "Solana Explorer"
      via: "Link to transaction using transactionSignature"
      pattern: "explorerUrl.*transactionSignature"
    - from: "apps/web/components/contributions/score-badge.tsx"
      to: "packages/utils/src/score.ts"
      via: "Displays pre-calculated score from database/API"
      pattern: "ContributionScore"
    - from: "apps/web/app/api/contributions/[wallet]/route.ts"
      to: "apps/web/prisma/schema.prisma"
      via: "prisma.contribution.findMany with wallet filter and pagination"
      pattern: "prisma\\.contribution"
---

<objective>
Build the contribution API endpoints, UI components, and integrate the contribution history and score display into the existing developer profile page.

Purpose: This is the user-facing layer of the contribution tracking system. Developers see their contribution history and score on their profile. Anyone can view any developer's contributions to verify their work. This completes the end-to-end flow from on-chain recording to user-visible display.

Output: Contribution API endpoints, contribution list/card/score components, updated profile page showing contributions and score, tree client helpers for TypeScript.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-contribution-tracking/02-RESEARCH.md
@.planning/phases/02-contribution-tracking/02-03-SUMMARY.md
@.planning/phases/02-contribution-tracking/02-04-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md

Key existing files:
@apps/web/app/(public)/profile/[wallet]/page.tsx
@apps/web/components/profile/profile-header.tsx
@apps/web/app/api/directory/route.ts (pagination pattern)
@apps/web/lib/db/prisma.ts
@packages/types/src/contribution.ts (from Plan 02)
@packages/utils/src/score.ts (from Plan 02)
@apps/web/prisma/schema.prisma (with Contribution model from Plan 04)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build contribution API endpoints and tree client helpers</name>
  <files>
    apps/web/app/api/contributions/[wallet]/route.ts
    apps/web/app/api/contributions/route.ts
    apps/web/lib/contributions/tree.ts
    apps/web/package.json
  </files>
  <action>
    **1. Install `@solana/spl-account-compression` in apps/web:**

    ```bash
    cd apps/web && pnpm add @solana/spl-account-compression@0.4.1
    ```

    This is the TypeScript SDK (NOT the Rust crate). It is compatible with @solana/web3.js v1 and provides `getConcurrentMerkleTreeAccountSize`, `createAllocTreeIx`, etc.

    **2. Create `apps/web/lib/contributions/tree.ts`:**

    Merkle tree TypeScript client helpers:

    ```typescript
    import {
      getConcurrentMerkleTreeAccountSize,
      createAllocTreeIx,
      SPL_ACCOUNT_COMPRESSION_PROGRAM_ID,
      SPL_NOOP_PROGRAM_ID,
    } from "@solana/spl-account-compression";
    import { Connection, Keypair, PublicKey, Transaction, SystemProgram } from "@solana/web3.js";

    // Default tree parameters (matching on-chain constants)
    export const DEFAULT_MAX_DEPTH = 16;
    export const DEFAULT_MAX_BUFFER_SIZE = 64;
    export const DEFAULT_CANOPY_DEPTH = 10;

    export const CONTRIBUTION_TREE_SEED = "contribution_tree";

    /** Derive the ContributionTreeConfig PDA */
    export function getContributionTreeConfigPDA(
      merkleTree: PublicKey,
      programId: PublicKey,
    ): [PublicKey, number] {
      return PublicKey.findProgramAddressSync(
        [Buffer.from(CONTRIBUTION_TREE_SEED), merkleTree.toBuffer()],
        programId,
      );
    }

    /** Calculate the space and rent needed for a contribution tree */
    export async function getTreeCost(
      connection: Connection,
      maxDepth = DEFAULT_MAX_DEPTH,
      maxBufferSize = DEFAULT_MAX_BUFFER_SIZE,
      canopyDepth = DEFAULT_CANOPY_DEPTH,
    ): Promise<{ space: number; lamports: number }> {
      const space = getConcurrentMerkleTreeAccountSize(maxDepth, maxBufferSize, canopyDepth);
      const lamports = await connection.getMinimumBalanceForRentExemption(space);
      return { space, lamports };
    }

    /** Create the allocate + init instructions for a new contribution tree */
    export async function createTreeAllocIx(
      connection: Connection,
      treeKeypair: Keypair,
      payer: PublicKey,
      maxDepth = DEFAULT_MAX_DEPTH,
      maxBufferSize = DEFAULT_MAX_BUFFER_SIZE,
      canopyDepth = DEFAULT_CANOPY_DEPTH,
    ) {
      return createAllocTreeIx(
        connection,
        treeKeypair.publicKey,
        payer,
        { maxDepth, maxBufferSize },
        canopyDepth,
      );
    }
    ```

    Export `SPL_ACCOUNT_COMPRESSION_PROGRAM_ID` and `SPL_NOOP_PROGRAM_ID` re-exports for convenience.

    **3. Create `apps/web/app/api/contributions/[wallet]/route.ts`:**

    GET endpoint returning paginated contributions for a specific wallet address.

    Follow the existing pagination pattern from `/api/directory/route.ts`:
    - Query params: `page` (default 1), `limit` (default 20, max 100)
    - Return: `{ contributions: ContributionRecord[], total: number, page: number, limit: number }`
    - Order by `createdAt DESC` (most recent first)
    - Include computed fields: format leafHash, contentHash, transactionSignature for display
    - Validate wallet address format (43-44 character base58 string)
    - Return 400 for invalid wallet format
    - Return 200 with empty array if wallet has no contributions

    Also include a summary in the response:
    ```typescript
    {
      contributions: [...],
      total: number,
      page: number,
      limit: number,
      summary: {
        tasksCompleted: number,
        averageVerificationScore: number, // human-readable 0-100
        // time_active_days and score come from the on-chain PDA, not calculated here
      }
    }
    ```

    The summary.tasksCompleted is just `total`. The summary.averageVerificationScore is computed from the contributions: `avg(verificationScore) / 100` (since stored as 0-10000, display as 0.00-100.00).

    **4. Create `apps/web/app/api/contributions/route.ts`:**

    GET endpoint for recent contributions across ALL developers (for a potential "Recent Activity" feed on the platform).

    - Query params: `page` (default 1), `limit` (default 20, max 50)
    - Return: `{ contributions: ContributionRecord[], total: number, page: number, limit: number }`
    - Order by `createdAt DESC`
    - Include the contributor's display name from the User relation (join)
    - No authentication required (public data)
  </action>
  <verify>
    1. `cd apps/web && npx tsc --noEmit` -- no type errors
    2. `grep -c "export async function GET" apps/web/app/api/contributions/\\[wallet\\]/route.ts` returns 1
    3. `grep -c "export async function GET" apps/web/app/api/contributions/route.ts` returns 1
    4. Tree helpers export getContributionTreeConfigPDA and getTreeCost functions
    5. @solana/spl-account-compression is in apps/web/package.json dependencies
  </verify>
  <done>
    Contribution API: GET /api/contributions/[wallet] returns paginated contributions with summary stats, GET /api/contributions returns recent activity feed. Tree client helpers provide PDA derivation, cost calculation, and tree allocation instruction builders. @solana/spl-account-compression v0.4.1 installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build contribution UI components and integrate into profile page</name>
  <files>
    apps/web/components/contributions/contribution-list.tsx
    apps/web/components/contributions/contribution-card.tsx
    apps/web/components/contributions/score-badge.tsx
    apps/web/app/(public)/profile/[wallet]/page.tsx
  </files>
  <action>
    **1. Create `apps/web/components/contributions/score-badge.tsx`:**

    A component that displays the developer's contribution score with a breakdown. Follows the existing GSD dark theme (emerald accent, dark backgrounds).

    Props:
    ```typescript
    interface ScoreBadgeProps {
      tasksCompleted: number;
      averageVerificationScore: number; // 0-100 (percentage)
      timeActiveDays: number;
      score: string; // BigInt string from on-chain
      scoreVersion: number;
      className?: string;
    }
    ```

    Display:
    - Primary: large score number (format the BigInt string: divide by 1e6, show 2 decimal places)
    - Label: "Contribution Score"
    - Below/tooltip: "X tasks | Y% avg score | Z days active"
    - Visual: emerald gradient background when score > 0, neutral when no contributions
    - If score is "0" or undefined, show "No contributions yet" with a subtle message

    Use the existing Card component from `@/components/ui/card`.

    **2. Create `apps/web/components/contributions/contribution-card.tsx`:**

    A compact card showing a single contribution. Similar to the existing ProfileCard pattern.

    Props:
    ```typescript
    interface ContributionCardProps {
      contribution: {
        taskRef: string;
        verificationScore: number;
        contentHash: string;
        transactionSignature: string;
        description?: string;
        createdAt: string; // ISO date
      };
    }
    ```

    Display:
    - Task reference (truncated hash or description if available)
    - Verification score as percentage bar (0-100%) with color coding: green (>80%), yellow (50-80%), red (<50%)
    - Timestamp (relative: "2 days ago", "1 hour ago")
    - Content hash (truncated, with copy button using existing CopyButton pattern from profile-header.tsx)
    - "Verify on-chain" link -> Solana Explorer transaction URL (use explorerUrl helper from transparency-config.ts, pass transactionSignature with type "tx")

    **3. Create `apps/web/components/contributions/contribution-list.tsx`:**

    A client component that displays paginated contributions. Follow the DirectoryGrid pattern (TanStack Query, pagination, loading skeletons).

    Props:
    ```typescript
    interface ContributionListProps {
      walletAddress: string;
      initialContributions?: ContributionRecord[]; // SSR initial data
      initialTotal?: number;
    }
    ```

    Implementation:
    - Use TanStack Query to fetch `/api/contributions/${walletAddress}?page=${page}&limit=10`
    - Show loading skeletons (3 card placeholders) while fetching
    - Render ContributionCard for each contribution
    - Pagination: "Load more" button or page numbers (follow DirectoryGrid pattern)
    - Empty state: "No contributions recorded yet" with subtle text explaining contributions are recorded on-chain

    **4. Update `apps/web/app/(public)/profile/[wallet]/page.tsx`:**

    Add the contribution section to the existing profile page. This is a Server Component, so:

    - Fetch contributions server-side via Prisma (direct query, matching the existing pattern of direct Prisma queries in Server Components -- per 01-03 decision):
      ```typescript
      const contributions = await prisma.contribution.findMany({
        where: { walletAddress: wallet },
        orderBy: { createdAt: 'desc' },
        take: 10,
      });
      const totalContributions = await prisma.contribution.count({
        where: { walletAddress: wallet },
      });
      ```

    - Compute summary stats server-side:
      ```typescript
      const summary = {
        tasksCompleted: totalContributions,
        averageVerificationScore: contributions.length > 0
          ? contributions.reduce((sum, c) => sum + c.verificationScore, 0) / contributions.length / 100
          : 0,
      };
      ```

    - Add the contribution section BELOW the existing profile header:
      ```tsx
      {/* Contribution Score */}
      <ScoreBadge
        tasksCompleted={summary.tasksCompleted}
        averageVerificationScore={summary.averageVerificationScore}
        timeActiveDays={0} // Will come from on-chain PDA in future
        score={user?.contributionScore ?? "0"} // Will come from on-chain PDA
        scoreVersion={1}
      />

      {/* Contribution History */}
      <section>
        <h2>Contribution History</h2>
        <ContributionList
          walletAddress={wallet}
          initialContributions={contributions}
          initialTotal={totalContributions}
        />
      </section>
      ```

    NOTE: In Phase 2, the on-chain score data (timeActiveDays, score from PDA) is not yet fetched from the blockchain on the profile page. The server-side summary provides tasksCompleted and averageVerificationScore from the database. The full on-chain score display will be functional once contributions are actually recorded and the PDA is updated. For now, use database-derived values as the display source. The ScoreBadge accepts these as props and displays them.

    Wrap the Prisma queries in try/catch for graceful degradation (matching the 01-04 pattern where database unavailability returns empty data, not errors).
  </action>
  <verify>
    1. `cd apps/web && npx tsc --noEmit` -- no type errors
    2. `cd apps/web && pnpm build` -- Next.js build succeeds (or `pnpm dev` starts without errors)
    3. Profile page at /profile/[wallet] renders without errors (even with 0 contributions)
    4. ScoreBadge shows "No contributions yet" when score is 0
    5. ContributionList shows empty state when no contributions exist
    6. ContributionCard renders verification score as percentage with correct color coding
  </verify>
  <done>
    Profile page displays contribution score badge with breakdown, paginated contribution history with on-chain verification links. ScoreBadge shows score or "No contributions yet". ContributionCard shows task ref, score bar, timestamp, content hash with copy button, and Solana Explorer link. ContributionList uses TanStack Query for pagination. All components follow GSD dark theme with emerald accent.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds at monorepo root (or `cd apps/web && pnpm build`)
2. Profile page renders with contribution section (empty state when no contributions)
3. API endpoints return proper JSON: GET /api/contributions/[wallet], GET /api/contributions
4. No import of helius-sdk in any file
5. @solana/spl-account-compression v0.4.1 installed in apps/web only (not in Rust crate dependencies)
6. Contribution cards include Solana Explorer links for on-chain verification
7. Score badge displays formatted score with breakdown
</verification>

<success_criteria>
- GET /api/contributions/[wallet] returns paginated contributions with summary stats
- GET /api/contributions returns recent activity feed across all developers
- Profile page shows contribution score badge and contribution history
- ContributionCard includes Solana Explorer transaction link for independent verification
- Tree client helpers provide PDA derivation and cost calculation for tree creation
- Empty state handles gracefully (no contributions yet)
- All TypeScript compiles and Next.js builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-contribution-tracking/02-05-SUMMARY.md`
</output>
