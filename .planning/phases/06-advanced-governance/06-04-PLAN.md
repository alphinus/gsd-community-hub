---
phase: 06-advanced-governance
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/web/app/api/webhooks/helius/route.ts
  - apps/web/lib/indexers/governance-advanced-indexer.ts
  - apps/web/app/api/governance/delegate/route.ts
  - apps/web/lib/governance/delegation.ts
autonomous: true

must_haves:
  truths:
    - "Delegation events from Helius webhooks create/update Delegation records in Prisma"
    - "GET /api/governance/delegate returns active delegations for a wallet (as delegator or delegate)"
  artifacts:
    - path: "apps/web/lib/indexers/governance-advanced-indexer.ts"
      provides: "Webhook processor for delegation and governance config update events"
      contains: "processDelegationEvent"
    - path: "apps/web/app/api/governance/delegate/route.ts"
      provides: "Delegation query API"
      exports: ["GET"]
    - path: "apps/web/lib/governance/delegation.ts"
      provides: "Delegation query helpers"
      contains: "getDelegationsForWallet"
  key_links:
    - from: "apps/web/app/api/webhooks/helius/route.ts"
      to: "apps/web/lib/indexers/governance-advanced-indexer.ts"
      via: "Webhook processor registration"
      pattern: "processAdvancedGovernanceEvent"
    - from: "apps/web/app/api/governance/delegate/route.ts"
      to: "apps/web/lib/governance/delegation.ts"
      via: "Helper function import"
      pattern: "getDelegationsForWallet"
---

<objective>
Build the webhook indexer for advanced governance events and the delegation query API -- the indexing layer that bridges on-chain delegation events to the off-chain database.

Purpose: On-chain delegation/revocation events must be indexed so the frontend can query delegation status. This is the data pipeline foundation that analytics and UI plans depend on.
Output: Extended webhook processor with delegation indexing, delegation query API, and delegation helper library.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-advanced-governance/06-RESEARCH.md
@.planning/phases/06-advanced-governance/06-01-SUMMARY.md
@.planning/phases/06-advanced-governance/06-02-SUMMARY.md

# Key source files
@apps/web/app/api/webhooks/helius/route.ts
@apps/web/lib/indexers/governance-indexer.ts
@apps/web/app/api/governance/rounds/route.ts
@apps/web/app/api/governance/deposit/route.ts
@apps/web/prisma/schema.prisma
@packages/utils/src/governance-pda.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create governance advanced indexer and extend Helius webhook with delegation processor</name>
  <files>
    apps/web/lib/indexers/governance-advanced-indexer.ts
    apps/web/app/api/webhooks/helius/route.ts
  </files>
  <action>
**governance-advanced-indexer.ts** -- Create NEW file following the existing indexer pattern (see contribution-indexer.ts, governance-indexer.ts):

Compute Anchor instruction discriminators for:
- `delegate_vote` -- SHA-256("global:delegate_vote")[0..8]
- `revoke_delegation` -- SHA-256("global:revoke_delegation")[0..8]
- `update_governance_config` -- SHA-256("global:update_governance_config")[0..8]

Create a reverse discriminator map for O(1) lookup (same pattern as governance-indexer.ts).

`processAdvancedGovernanceEvent(transaction)` function:
1. For each instruction in the transaction, check discriminator against the map
2. **delegate_vote**: Extract delegator (signer), delegate, delegated_amount from instruction accounts/data. Upsert Delegation record in Prisma with `onChainAddress` (DelegationRecord PDA), `delegatorWallet`, `delegateWallet`, `delegatedAmount`, `isActive: true`, `effectiveFromRound`, `transactionSignature`, `delegatedAt`
3. **revoke_delegation**: Find Delegation by delegatorWallet, set `isActive: false`, `revokedAt: new Date()`
4. **update_governance_config**: Log the config update (no separate model needed, but could update a cached config if desired)

Use `prisma.delegation.upsert` with `onChainAddress` as unique key for idempotency (same pattern as other indexers).

**route.ts** (webhook) -- Add the advanced governance processor to the existing multi-processor pipeline. The current pipeline is 5-processor (contribution + governance + revenue + detection + verification). Add `processAdvancedGovernanceEvent` as the 6th processor. Import from governance-advanced-indexer.ts.

Wrap in try/catch per existing pattern -- individual processor failures don't block others.
  </action>
  <verify>
Verify indexer file exists: `ls apps/web/lib/indexers/governance-advanced-indexer.ts`
Verify webhook imports new processor: `grep "processAdvancedGovernanceEvent" apps/web/app/api/webhooks/helius/route.ts`
Verify discriminator computation: `grep "delegate_vote" apps/web/lib/indexers/governance-advanced-indexer.ts`
Run `npx tsc --noEmit` in apps/web to check TypeScript compilation.
  </verify>
  <done>
governance-advanced-indexer.ts processes delegate_vote (creates Delegation), revoke_delegation (deactivates Delegation), and update_governance_config events. Helius webhook runs 6 processors in pipeline. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delegation helper library and delegation query API endpoint</name>
  <files>
    apps/web/lib/governance/delegation.ts
    apps/web/app/api/governance/delegate/route.ts
  </files>
  <action>
**lib/governance/delegation.ts** -- Create helper library:
- `getDelegationsForWallet(wallet: string)`: Returns all delegations where wallet is delegator OR delegate. Query Prisma `delegation.findMany({ where: { OR: [{ delegatorWallet: wallet }, { delegateWallet: wallet }] } })`.
- `getDelegateStats(wallet: string)`: Returns aggregate stats for a delegate -- total delegators, total delegated amount. Uses Prisma `delegation.aggregate`.
- `getActiveDelegations()`: Returns all active delegations with counts for analytics. This will be consumed by the analytics API in Plan 06-05.

**api/governance/delegate/route.ts** -- GET endpoint:
- Query param: `wallet` (required)
- Returns: `{ delegations: DelegationInfo[], stats: { asDelegator: DelegationInfo | null, asDelegate: { delegatorCount, totalDelegated } } }`
- Public endpoint (no auth -- delegation info is transparent)
- Use getDelegationsForWallet and getDelegateStats from the helper library
  </action>
  <verify>
Verify API route exists: `ls apps/web/app/api/governance/delegate/route.ts`
Verify helper library: `ls apps/web/lib/governance/delegation.ts`
Run `npx tsc --noEmit` in apps/web -- must compile.
Verify helper exports: `grep "getDelegationsForWallet\|getDelegateStats\|getActiveDelegations" apps/web/lib/governance/delegation.ts`
  </verify>
  <done>
Delegation helper library provides getDelegationsForWallet, getDelegateStats, and getActiveDelegations. GET /api/governance/delegate returns delegations and stats for a wallet. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- All 4 new/modified files compile with `npx tsc --noEmit`
- Helius webhook processes 6 instruction types (existing 5 + advanced governance)
- Delegation API returns correct JSON shape
- Delegation helper functions are reusable by analytics plan
</verification>

<success_criteria>
- Delegation events indexed from Helius webhooks
- GET /api/governance/delegate returns delegations for a wallet
- Delegation helper library exported for reuse
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-governance/06-04-SUMMARY.md`
</output>
