---
phase: 06-advanced-governance
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - apps/web/app/api/webhooks/helius/route.ts
  - apps/web/lib/indexers/governance-advanced-indexer.ts
  - apps/web/app/api/governance/delegate/route.ts
  - apps/web/app/api/governance/human-verification/route.ts
  - apps/web/app/api/governance/analytics/route.ts
  - apps/web/app/api/governance/decay/route.ts
  - apps/web/lib/governance/delegation.ts
  - apps/web/lib/governance/decay.ts
autonomous: true

must_haves:
  truths:
    - "Delegation events from Helius webhooks create/update Delegation records in Prisma"
    - "GET /api/governance/delegate returns active delegations for a wallet (as delegator or delegate)"
    - "GET /api/governance/human-verification returns Civic Pass verification status for a wallet"
    - "GET /api/governance/analytics returns voter turnout, power distribution, and delegation stats"
    - "POST /api/governance/decay triggers decayed score recomputation for a developer"
  artifacts:
    - path: "apps/web/lib/indexers/governance-advanced-indexer.ts"
      provides: "Webhook processor for delegation and governance config update events"
      contains: "processDelegationEvent"
    - path: "apps/web/app/api/governance/delegate/route.ts"
      provides: "Delegation CRUD API"
      exports: ["GET"]
    - path: "apps/web/app/api/governance/human-verification/route.ts"
      provides: "Human verification status API"
      exports: ["GET"]
    - path: "apps/web/app/api/governance/analytics/route.ts"
      provides: "Governance analytics API"
      exports: ["GET"]
    - path: "apps/web/app/api/governance/decay/route.ts"
      provides: "Decay score recomputation trigger"
      exports: ["POST"]
    - path: "apps/web/lib/governance/delegation.ts"
      provides: "Delegation query helpers"
      contains: "getDelegationsForWallet"
    - path: "apps/web/lib/governance/decay.ts"
      provides: "Decay computation pipeline"
      contains: "computeDecayedScoreForDeveloper"
  key_links:
    - from: "apps/web/app/api/webhooks/helius/route.ts"
      to: "apps/web/lib/indexers/governance-advanced-indexer.ts"
      via: "Webhook processor registration"
      pattern: "processAdvancedGovernanceEvent"
    - from: "apps/web/lib/governance/decay.ts"
      to: "@gsd/utils decay.ts"
      via: "Import shared decay utility"
      pattern: "calculateDecayedScore"
    - from: "apps/web/app/api/governance/analytics/route.ts"
      to: "apps/web/prisma/schema.prisma"
      via: "Prisma aggregate queries"
      pattern: "prisma\\.delegation"
---

<objective>
Build the API layer and webhook indexer for advanced governance: delegation event processing, delegation query endpoints, human verification status, governance analytics, and decay score recomputation pipeline.

Purpose: Bridge between on-chain events and the frontend. The webhook indexes delegation events, APIs serve delegation/verification/analytics data, and the decay endpoint triggers score recalculation.
Output: Extended webhook processor, 4 API endpoints, delegation and decay helper libraries.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-advanced-governance/06-RESEARCH.md
@.planning/phases/06-advanced-governance/06-01-SUMMARY.md
@.planning/phases/06-advanced-governance/06-02-SUMMARY.md
@.planning/phases/06-advanced-governance/06-03-SUMMARY.md

# Key source files
@apps/web/app/api/webhooks/helius/route.ts
@apps/web/app/api/governance/rounds/route.ts
@apps/web/app/api/governance/deposit/route.ts
@apps/web/app/api/governance/votes/route.ts
@apps/web/prisma/schema.prisma
@packages/utils/src/governance-pda.ts
@packages/utils/src/decay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create governance advanced indexer and extend Helius webhook with delegation processor</name>
  <files>
    apps/web/lib/indexers/governance-advanced-indexer.ts
    apps/web/app/api/webhooks/helius/route.ts
  </files>
  <action>
**governance-advanced-indexer.ts** -- Create NEW file following the existing indexer pattern (see contribution-indexer.ts, governance-indexer.ts):

Compute Anchor instruction discriminators for:
- `delegate_vote` -- SHA-256("global:delegate_vote")[0..8]
- `revoke_delegation` -- SHA-256("global:revoke_delegation")[0..8]
- `update_governance_config` -- SHA-256("global:update_governance_config")[0..8]

Create a reverse discriminator map for O(1) lookup (same pattern as governance-indexer.ts).

`processAdvancedGovernanceEvent(transaction)` function:
1. For each instruction in the transaction, check discriminator against the map
2. **delegate_vote**: Extract delegator (signer), delegate, delegated_amount from instruction accounts/data. Upsert Delegation record in Prisma with `onChainAddress` (DelegationRecord PDA), `delegatorWallet`, `delegateWallet`, `delegatedAmount`, `isActive: true`, `effectiveFromRound`, `transactionSignature`, `delegatedAt`
3. **revoke_delegation**: Find Delegation by delegatorWallet, set `isActive: false`, `revokedAt: new Date()`
4. **update_governance_config**: Log the config update (no separate model needed, but could update a cached config if desired)

Use `prisma.delegation.upsert` with `onChainAddress` as unique key for idempotency (same pattern as other indexers).

**route.ts** (webhook) -- Add the advanced governance processor to the existing multi-processor pipeline. The current pipeline is 5-processor (contribution + governance + revenue + detection + verification). Add `processAdvancedGovernanceEvent` as the 6th processor. Import from governance-advanced-indexer.ts.

Wrap in try/catch per existing pattern -- individual processor failures don't block others.
  </action>
  <verify>
Verify indexer file exists: `ls apps/web/lib/indexers/governance-advanced-indexer.ts`
Verify webhook imports new processor: `grep "processAdvancedGovernanceEvent" apps/web/app/api/webhooks/helius/route.ts`
Verify discriminator computation: `grep "delegate_vote" apps/web/lib/indexers/governance-advanced-indexer.ts`
Run `npx tsc --noEmit` in apps/web to check TypeScript compilation.
  </verify>
  <done>
governance-advanced-indexer.ts processes delegate_vote (creates Delegation), revoke_delegation (deactivates Delegation), and update_governance_config events. Helius webhook runs 6 processors in pipeline. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delegation, human verification, analytics, and decay API endpoints with helper libraries</name>
  <files>
    apps/web/app/api/governance/delegate/route.ts
    apps/web/app/api/governance/human-verification/route.ts
    apps/web/app/api/governance/analytics/route.ts
    apps/web/app/api/governance/decay/route.ts
    apps/web/lib/governance/delegation.ts
    apps/web/lib/governance/decay.ts
  </files>
  <action>
**lib/governance/delegation.ts** -- Create helper library:
- `getDelegationsForWallet(wallet: string)`: Returns all delegations where wallet is delegator OR delegate. Query Prisma `delegation.findMany({ where: { OR: [{ delegatorWallet: wallet }, { delegateWallet: wallet }] } })`.
- `getDelegateStats(wallet: string)`: Returns aggregate stats for a delegate -- total delegators, total delegated amount. Uses Prisma `delegation.aggregate`.
- `getActiveDelegations()`: Returns all active delegations with counts for analytics.

**lib/governance/decay.ts** -- Create decay pipeline:
- `computeDecayedScoreForDeveloper(wallet: string, halfLifeDays?: number)`:
  1. Fetch all contributions for the developer from Prisma (with `createdAt`)
  2. For each contribution, compute `ageDays = Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24))`
  3. Map to `{ verificationScore, ageDays }`
  4. Call `calculateDecayedScore()` from `@gsd/utils`
  5. Recompute contribution score using the decayed total via `calculateContributionScore()` from `@gsd/utils`
  6. Return `{ originalScore, decayedScore, decayedTotal, contributionCount }`

**api/governance/delegate/route.ts** -- GET endpoint:
- Query param: `wallet` (required)
- Returns: `{ delegations: DelegationInfo[], stats: { asDelegator: DelegationInfo | null, asDelegate: { delegatorCount, totalDelegated } } }`
- Public endpoint (no auth -- delegation info is transparent)

**api/governance/human-verification/route.ts** -- GET endpoint:
- Query param: `wallet` (required)
- Returns: `{ verified: boolean, verifiedAt: string | null, expiresAt: string | null, gatekeeperNetwork: string | null }`
- Query Prisma HumanVerification model
- Public endpoint

**api/governance/analytics/route.ts** -- GET endpoint:
- No required params
- Returns GovernanceAnalytics object:
  - `turnoutByRound`: For each closed round, count distinct voters / total depositors. Query: `prisma.vote.groupBy({ by: ['roundOnChainAddress'], _count: { voterWallet: true } })` + total depositors from VoteDeposit count
  - `powerDistribution`: Query all VoteDeposit deposited amounts, compute Gini coefficient and top-10 concentration. Gini formula: `G = (2 * sum(i * x_i)) / (n * sum(x_i)) - (n + 1) / n` where x_i is sorted ascending
  - `delegationStats`: Total active delegations, total delegated tokens, top 5 delegates by delegator count
  - `participationTrends`: 30/60/90 day rolling averages of voter turnout using Vote.votedAt timestamps
- Cache with `Cache-Control: public, max-age=300` (5 minutes) since analytics are expensive queries

**api/governance/decay/route.ts** -- POST endpoint:
- Body: `{ wallet: string }` (required)
- Auth: Require valid session (authenticated user can trigger decay recomputation for themselves)
- Returns: `{ originalScore, decayedScore, decayedTotal, contributionCount }`
- Calls `computeDecayedScoreForDeveloper(wallet, halfLifeDays)` where halfLifeDays comes from GovernanceConfig (query from on-chain or use default 180)
- NOTE: This does NOT update on-chain score -- it returns the computed values. On-chain update would require server-side transaction signing (deferred to cron/admin trigger).
  </action>
  <verify>
Verify all 4 API routes exist: `ls apps/web/app/api/governance/delegate/route.ts apps/web/app/api/governance/human-verification/route.ts apps/web/app/api/governance/analytics/route.ts apps/web/app/api/governance/decay/route.ts`
Verify helper libraries: `ls apps/web/lib/governance/delegation.ts apps/web/lib/governance/decay.ts`
Run `npx tsc --noEmit` in apps/web -- must compile.
Verify decay uses shared utility: `grep "calculateDecayedScore" apps/web/lib/governance/decay.ts`
Verify analytics has Gini: `grep -i "gini" apps/web/app/api/governance/analytics/route.ts`
  </verify>
  <done>
4 API endpoints serve delegation info (GET), human verification status (GET), governance analytics with Gini coefficient (GET, cached 5min), and decay score computation (POST, authenticated). Helper libraries provide reusable query functions. All import from @gsd/utils for shared computation.
  </done>
</task>

</tasks>

<verification>
- All 8 new/modified files compile with `npx tsc --noEmit`
- Helius webhook processes 6 instruction types (existing 5 + advanced governance)
- API endpoints return correct JSON shapes
- Decay computation uses shared @gsd/utils functions
- Analytics endpoint computes Gini coefficient
</verification>

<success_criteria>
- Delegation events indexed from Helius webhooks
- GET /api/governance/delegate returns delegations for a wallet
- GET /api/governance/human-verification returns Civic Pass status
- GET /api/governance/analytics returns turnout, power distribution, delegation stats
- POST /api/governance/decay computes and returns decayed contribution score
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-governance/06-04-SUMMARY.md`
</output>
