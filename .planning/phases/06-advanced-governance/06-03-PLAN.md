---
phase: 06-advanced-governance
plan: 03
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/utils/src/decay.ts
  - packages/utils/src/decay.test.ts
  - packages/utils/src/score.ts
  - packages/utils/src/index.ts
autonomous: true

must_haves:
  truths:
    - "decayMultiplier returns 1.0 for age 0, 0.5 for age equal to half-life, and approaches 0 for very old contributions"
    - "calculateDecayedScore sums each contribution's verification score weighted by its age-based decay multiplier"
    - "calculateContributionScoreWithDecay produces a lower score than calculateContributionScore for the same inputs when contributions are old"
    - "All decay functions are deterministic: same inputs always produce same output"
    - "DECAY_HALF_LIFE_DAYS defaults to 180 but is configurable as a parameter"
  artifacts:
    - path: "packages/utils/src/decay.ts"
      provides: "Reputation decay computation functions"
      exports: ["decayMultiplier", "calculateDecayedScore", "DECAY_HALF_LIFE_DAYS"]
    - path: "packages/utils/src/decay.test.ts"
      provides: "TDD test suite for decay functions"
      min_lines: 40
  key_links:
    - from: "packages/utils/src/decay.ts"
      to: "packages/utils/src/score.ts"
      via: "Shared contribution score computation with decay"
      pattern: "calculateContributionScore"
---

<objective>
Implement the reputation decay computation as a shared utility with TDD methodology. The decay formula uses exponential half-life: each contribution's verification score is multiplied by `2^(-age/halfLife)`, producing a decayed total that feeds into the existing contribution score formula.

Purpose: Incentivize sustained participation by making old contributions count less over time. This affects revenue share proportions, so correctness is critical -- TDD ensures the math is right.
Output: decay.ts utility with decayMultiplier, calculateDecayedScore, and calculateContributionScoreWithDecay functions, plus comprehensive test suite.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-advanced-governance/06-RESEARCH.md
@.planning/phases/06-advanced-governance/06-01-SUMMARY.md

# Key source files
@packages/utils/src/score.ts
@packages/utils/src/index.ts
</context>

<feature>
  <name>Reputation Decay Computation</name>
  <files>packages/utils/src/decay.ts, packages/utils/src/decay.test.ts</files>
  <behavior>
**decayMultiplier(ageDays, halfLifeDays?)**
- Input: age in days (number), optional half-life (default 180)
- Output: multiplier between 0 and 1 (number)
- Cases:
  - decayMultiplier(0, 180) -> 1.0
  - decayMultiplier(180, 180) -> 0.5
  - decayMultiplier(360, 180) -> 0.25
  - decayMultiplier(540, 180) -> 0.125
  - decayMultiplier(-10, 180) -> 1.0 (negative age treated as 0)
  - decayMultiplier(0, 0) -> 1.0 (edge case: zero half-life)

**calculateDecayedScore(contributions, halfLifeDays?)**
- Input: array of { verificationScore: number, ageDays: number }, optional half-life
- Output: BigInt (decayed total verification score)
- Cases:
  - [] -> 0n (empty array)
  - [{ verificationScore: 10000, ageDays: 0 }] -> 10000n (no decay)
  - [{ verificationScore: 10000, ageDays: 180 }] -> 5000n (half-life)
  - [{ vs: 10000, age: 0 }, { vs: 10000, age: 180 }] -> 15000n (10000 + 5000)
  - [{ vs: 10000, age: 360 }] -> 2500n (two half-lives)

**calculateContributionScoreWithDecay(input)**
- Input: ScoreInput (from score.ts) + contributions array for decay
- Output: BigInt contribution score using decayed verification total
- Must produce LOWER score than calculateContributionScore when contributions are old
  </behavior>
  <implementation>
1. Create decay.ts with:
   - DECAY_HALF_LIFE_DAYS constant = 180
   - decayMultiplier: `Math.pow(2, -ageDays / halfLifeDays)` with edge case handling
   - calculateDecayedScore: iterate contributions, apply decayMultiplier to each verificationScore, sum, round to BigInt
   - calculateContributionScoreWithDecay: wrapper that takes ScoreInput + contributions, computes decayed total, calls calculateContributionScore from score.ts with the decayed total

2. Use node:test runner (existing pattern from 02-02)

3. Export from index.ts barrel
  </implementation>
</feature>

<verification>
- All RED tests fail before implementation
- All GREEN tests pass after implementation
- `node --test packages/utils/src/decay.test.ts` passes
- Edge cases covered: empty array, zero age, negative age, zero half-life, multiple half-lives
</verification>

<success_criteria>
- decayMultiplier(180, 180) === 0.5 (exact half-life)
- calculateDecayedScore with mixed-age contributions produces correct weighted sum
- calculateContributionScoreWithDecay < calculateContributionScore for aged contributions
- All tests pass with node:test runner
- Functions exported from @gsd/utils barrel
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-governance/06-03-SUMMARY.md`
</output>
