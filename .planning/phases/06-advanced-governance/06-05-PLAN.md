---
phase: 06-advanced-governance
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-03", "06-04"]
files_modified:
  - apps/web/app/api/governance/human-verification/route.ts
  - apps/web/app/api/governance/analytics/route.ts
  - apps/web/app/api/governance/decay/route.ts
  - apps/web/lib/governance/decay.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/governance/human-verification returns Civic Pass verification status for a wallet"
    - "GET /api/governance/analytics returns voter turnout, power distribution, and delegation stats"
    - "POST /api/governance/decay triggers decayed score recomputation for a developer"
  artifacts:
    - path: "apps/web/app/api/governance/human-verification/route.ts"
      provides: "Human verification status API"
      exports: ["GET"]
    - path: "apps/web/app/api/governance/analytics/route.ts"
      provides: "Governance analytics API with Gini coefficient"
      exports: ["GET"]
    - path: "apps/web/app/api/governance/decay/route.ts"
      provides: "Decay score recomputation trigger"
      exports: ["POST"]
    - path: "apps/web/lib/governance/decay.ts"
      provides: "Decay computation pipeline"
      contains: "computeDecayedScoreForDeveloper"
  key_links:
    - from: "apps/web/lib/governance/decay.ts"
      to: "@gsd/utils decay.ts"
      via: "Import shared decay utility"
      pattern: "calculateDecayedScore"
    - from: "apps/web/app/api/governance/analytics/route.ts"
      to: "apps/web/lib/governance/delegation.ts"
      via: "Import delegation helpers for stats"
      pattern: "getActiveDelegations"
    - from: "apps/web/app/api/governance/analytics/route.ts"
      to: "apps/web/prisma/schema.prisma"
      via: "Prisma aggregate queries for Gini computation"
      pattern: "prisma\\.voteDeposit"
---

<objective>
Build the analytics, decay, and human verification API endpoints -- the computation and query layer that serves governance insights and reputation decay data to the frontend.

Purpose: These endpoints provide the data-heavy computations (Gini coefficient, decay scores, participation trends) that feed the analytics dashboard and profile displays. Separated from the indexing layer (Plan 04) for better testability and context budget.
Output: 3 API endpoints (human-verification, analytics, decay), and a decay computation helper library.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-advanced-governance/06-RESEARCH.md
@.planning/phases/06-advanced-governance/06-01-SUMMARY.md
@.planning/phases/06-advanced-governance/06-03-SUMMARY.md
@.planning/phases/06-advanced-governance/06-04-SUMMARY.md

# Key source files
@apps/web/app/api/governance/votes/route.ts
@apps/web/lib/governance/delegation.ts
@apps/web/prisma/schema.prisma
@packages/utils/src/decay.ts
@packages/utils/src/score.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create human verification API and decay computation pipeline with helper library</name>
  <files>
    apps/web/app/api/governance/human-verification/route.ts
    apps/web/app/api/governance/decay/route.ts
    apps/web/lib/governance/decay.ts
  </files>
  <action>
**api/governance/human-verification/route.ts** -- GET endpoint:
- Query param: `wallet` (required)
- Returns: `{ verified: boolean, verifiedAt: string | null, expiresAt: string | null, gatekeeperNetwork: string | null }`
- Query Prisma HumanVerification model
- Public endpoint

**lib/governance/decay.ts** -- Create decay pipeline:
- `computeDecayedScoreForDeveloper(wallet: string, halfLifeDays?: number)`:
  1. Fetch all contributions for the developer from Prisma (with `createdAt`)
  2. For each contribution, compute `ageDays = Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24))`
  3. Map to `{ verificationScore, ageDays }`
  4. Call `calculateDecayedScore()` from `@gsd/utils`
  5. Recompute contribution score using the decayed total via `calculateContributionScore()` from `@gsd/utils`
  6. Return `{ originalScore, decayedScore, decayedTotal, contributionCount }`

**api/governance/decay/route.ts** -- POST endpoint:
- Body: `{ wallet: string }` (required)
- Auth: Require valid session (authenticated user can trigger decay recomputation for themselves)
- Returns: `{ originalScore, decayedScore, decayedTotal, contributionCount }`
- Calls `computeDecayedScoreForDeveloper(wallet, halfLifeDays)` where halfLifeDays comes from GovernanceConfig (query from on-chain or use default 180)
- NOTE: This does NOT update on-chain score -- it returns the computed values. On-chain update would require server-side transaction signing (deferred to cron/admin trigger).
  </action>
  <verify>
Verify files exist: `ls apps/web/app/api/governance/human-verification/route.ts apps/web/app/api/governance/decay/route.ts apps/web/lib/governance/decay.ts`
Run `npx tsc --noEmit` in apps/web -- must compile.
Verify decay uses shared utility: `grep "calculateDecayedScore" apps/web/lib/governance/decay.ts`
  </verify>
  <done>
Human verification API returns Civic Pass status for a wallet. Decay helper computes decayed scores using @gsd/utils. Decay API endpoint returns original vs decayed scores for authenticated users. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create governance analytics API endpoint with Gini coefficient and participation metrics</name>
  <files>
    apps/web/app/api/governance/analytics/route.ts
  </files>
  <action>
**api/governance/analytics/route.ts** -- GET endpoint:
- No required params
- Returns GovernanceAnalytics object:
  - `turnoutByRound`: For each closed round, count distinct voters / total depositors. Query: `prisma.vote.groupBy({ by: ['roundOnChainAddress'], _count: { voterWallet: true } })` + total depositors from VoteDeposit count
  - `powerDistribution`: Query all VoteDeposit deposited amounts, compute Gini coefficient and top-10 concentration. Gini formula: `G = (2 * sum(i * x_i)) / (n * sum(x_i)) - (n + 1) / n` where x_i is sorted ascending
  - `delegationStats`: Import `getActiveDelegations` from `@/lib/governance/delegation` (from Plan 04). Compute total active delegations, total delegated tokens, top 5 delegates by delegator count
  - `participationTrends`: 30/60/90 day rolling averages of voter turnout using Vote.votedAt timestamps
- Cache with `Cache-Control: public, max-age=300` (5 minutes) since analytics are expensive queries

**Gini coefficient implementation:**
```typescript
function computeGini(amounts: number[]): number {
  if (amounts.length === 0) return 0;
  const sorted = [...amounts].sort((a, b) => a - b);
  const n = sorted.length;
  const totalSum = sorted.reduce((acc, x) => acc + x, 0);
  if (totalSum === 0) return 0;
  const weightedSum = sorted.reduce((acc, x, i) => acc + (i + 1) * x, 0);
  return (2 * weightedSum) / (n * totalSum) - (n + 1) / n;
}
```
  </action>
  <verify>
Verify API route exists: `ls apps/web/app/api/governance/analytics/route.ts`
Run `npx tsc --noEmit` in apps/web -- must compile.
Verify Gini computation: `grep -i "gini" apps/web/app/api/governance/analytics/route.ts`
Verify delegation import: `grep "getActiveDelegations" apps/web/app/api/governance/analytics/route.ts`
  </verify>
  <done>
Analytics API returns turnout by round, power distribution with Gini coefficient and top-10 concentration, delegation stats (using helpers from Plan 04), and participation trends. Cached for 5 minutes. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- All 4 new files compile with `npx tsc --noEmit`
- Analytics endpoint computes Gini coefficient correctly
- Decay computation uses shared @gsd/utils functions
- Analytics imports delegation helpers from Plan 04 output
</verification>

<success_criteria>
- GET /api/governance/human-verification returns Civic Pass status
- GET /api/governance/analytics returns turnout, power distribution with Gini, delegation stats
- POST /api/governance/decay computes and returns decayed contribution score
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-governance/06-05-SUMMARY.md`
</output>
