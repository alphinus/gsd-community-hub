---
phase: 06-advanced-governance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - programs/gsd-hub/src/state/governance_config.rs
  - programs/gsd-hub/src/state/delegation_record.rs
  - programs/gsd-hub/src/state/mod.rs
  - programs/gsd-hub/src/errors.rs
  - packages/types/src/governance.ts
  - packages/types/src/identity.ts
  - packages/types/src/index.ts
  - packages/utils/src/governance-pda.ts
  - packages/utils/src/index.ts
  - apps/web/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "GovernanceConfig struct has quadratic_voting_enabled flag, civic_gatekeeper_network pubkey, and decay_half_life_days field"
    - "DelegationRecord PDA struct exists with delegator, delegate, delegated_amount, effective_from_round, and is_active fields"
    - "GovernanceError enum includes HumanVerificationRequired, InvalidDelegation, DelegationInactive, VotingPowerDelegated, DelegationAlreadyExists, and NoDelegation errors"
    - "TypeScript types mirror all new Rust enums and struct fields"
    - "PDA derivation for DelegationRecord is consistent between Rust seeds and TypeScript helper"
    - "Prisma schema has Delegation and HumanVerification models with correct indexes"
  artifacts:
    - path: "programs/gsd-hub/src/state/delegation_record.rs"
      provides: "DelegationRecord PDA struct"
      contains: "pub struct DelegationRecord"
    - path: "programs/gsd-hub/src/state/governance_config.rs"
      provides: "Extended GovernanceConfig with quadratic + Civic + decay fields"
      contains: "quadratic_voting_enabled"
    - path: "packages/types/src/identity.ts"
      provides: "Identity verification TypeScript types"
      contains: "HumanVerification"
    - path: "packages/utils/src/governance-pda.ts"
      provides: "getDelegationPDA helper"
      contains: "getDelegationPDA"
    - path: "apps/web/prisma/schema.prisma"
      provides: "Delegation and HumanVerification Prisma models"
      contains: "model Delegation"
  key_links:
    - from: "programs/gsd-hub/src/state/delegation_record.rs"
      to: "packages/utils/src/governance-pda.ts"
      via: "PDA seed matching"
      pattern: "delegation.*delegator"
    - from: "programs/gsd-hub/src/state/governance_config.rs"
      to: "packages/types/src/governance.ts"
      via: "Type mirroring"
      pattern: "quadratic_voting_enabled"
---

<objective>
Create the on-chain state foundation and off-chain type layer for Phase 6 advanced governance: extend GovernanceConfig with quadratic voting + Civic Pass + decay fields, add DelegationRecord PDA, extend error codes, create TypeScript type mirrors, PDA helpers, and Prisma models.

Purpose: All subsequent Phase 6 plans (instructions, API, UI) depend on these state definitions being correct and consistent across Rust, TypeScript, and Prisma.
Output: Extended GovernanceConfig, new DelegationRecord struct, TS types, PDA derivations, Prisma models.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-governance/06-RESEARCH.md
@.planning/phases/03-governance-idea-rounds/03-01-SUMMARY.md
@.planning/phases/05-gsd-framework-integration/05-01-SUMMARY.md

# Key source files to read before modifying
@programs/gsd-hub/src/state/governance_config.rs
@programs/gsd-hub/src/state/vote_deposit.rs
@programs/gsd-hub/src/state/mod.rs
@programs/gsd-hub/src/errors.rs
@packages/types/src/governance.ts
@packages/utils/src/governance-pda.ts
@packages/types/src/index.ts
@packages/utils/src/index.ts
@apps/web/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GovernanceConfig, create DelegationRecord PDA, and add error codes</name>
  <files>
    programs/gsd-hub/src/state/governance_config.rs
    programs/gsd-hub/src/state/delegation_record.rs
    programs/gsd-hub/src/state/mod.rs
    programs/gsd-hub/src/errors.rs
  </files>
  <action>
**governance_config.rs** -- Append 3 new fields to GovernanceConfig struct AFTER existing fields (backward-compatible extension requires realloc in update instruction later):
- `pub quadratic_voting_enabled: bool` (1 byte) -- flag for staged rollout
- `pub civic_gatekeeper_network: Pubkey` (32 bytes) -- Civic Pass gatekeeper network, default Pubkey::default() when disabled
- `pub decay_half_life_days: u16` (2 bytes) -- default 180, configurable via governance

Update the byte count comment: existing 133 + 1 + 32 + 2 = 168 bytes total.

**delegation_record.rs** -- Create NEW file with DelegationRecord account struct:
```rust
#[account]
#[derive(InitSpace)]
pub struct DelegationRecord {
    pub delegator: Pubkey,        // 32 bytes
    pub delegate: Pubkey,         // 32 bytes
    pub bump: u8,                 // 1 byte
    pub delegated_amount: u64,    // 8 bytes
    pub delegated_at: i64,        // 8 bytes
    pub is_active: bool,          // 1 byte
    pub effective_from_round: u32, // 4 bytes
}
```
PDA seeds: `["delegation", delegator.key()]`. Total: 8 (disc) + 32 + 32 + 1 + 8 + 8 + 1 + 4 = 94 bytes.

**mod.rs** -- Add `pub mod delegation_record;` and re-export `DelegationRecord`.

**errors.rs** -- Extend GovernanceError enum with 6 new variants (append AFTER existing variants):
- `HumanVerificationRequired` -- "Civic Pass verification required for quadratic voting"
- `InvalidDelegation` -- "Delegation record does not match voter"
- `DelegationInactive` -- "Delegation is not active"
- `VotingPowerDelegated` -- "Cannot vote directly while voting power is delegated"
- `DelegationAlreadyExists` -- "Active delegation already exists for this wallet"
- `NoDelegation` -- "No active delegation found to revoke"

Run `anchor build` to verify compilation. All existing tests should still pass since no instruction logic changed.
  </action>
  <verify>
Run `cd programs/gsd-hub && anchor build` -- must compile without errors.
Run `anchor test` in the programs/gsd-hub directory -- all existing tests must pass (no regressions).
Verify DelegationRecord struct exists: `grep "pub struct DelegationRecord" programs/gsd-hub/src/state/delegation_record.rs`
Verify new GovernanceConfig fields: `grep "quadratic_voting_enabled" programs/gsd-hub/src/state/governance_config.rs`
Verify new error codes: `grep "HumanVerificationRequired" programs/gsd-hub/src/errors.rs`
  </verify>
  <done>
GovernanceConfig has 3 new fields (quadratic_voting_enabled, civic_gatekeeper_network, decay_half_life_days). DelegationRecord PDA struct compiles with InitSpace. GovernanceError has 6 new variants. All existing 31+ tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types, PDA helpers, and Prisma models for delegation and identity</name>
  <files>
    packages/types/src/governance.ts
    packages/types/src/identity.ts
    packages/types/src/index.ts
    packages/utils/src/governance-pda.ts
    packages/utils/src/index.ts
    apps/web/prisma/schema.prisma
  </files>
  <action>
**packages/types/src/identity.ts** -- Create NEW file with identity verification types:
- `HumanVerificationStatus` type: `'pending' | 'verified' | 'expired'`
- `HumanVerificationInfo` interface: `{ walletAddress: string, gatekeeperNetwork: string, verified: boolean, verifiedAt: string | null, expiresAt: string | null }`
- `DelegationInfo` interface: `{ id: string, delegatorWallet: string, delegateWallet: string, delegatedAmount: string (BigInt as string), isActive: boolean, effectiveFromRound: number, delegatedAt: string }`
- `DelegationStats` interface: `{ totalDelegations: number, totalDelegatedTokens: string, topDelegates: Array<{ wallet: string, delegatorCount: number, totalDelegated: string }> }`

**packages/types/src/governance.ts** -- Extend existing GovernanceConfig interface with new fields:
- `quadraticVotingEnabled: boolean`
- `civicGatekeeperNetwork: string`
- `decayHalfLifeDays: number`

**packages/types/src/index.ts** -- Add barrel export for identity module: `export * from './identity'`

**packages/utils/src/governance-pda.ts** -- Add getDelegationPDA function:
```typescript
export const DELEGATION_SEED = "delegation";

export function getDelegationPDA(
  delegator: PublicKey,
  programId: PublicKey
): [PublicKey, number] {
  return PublicKey.findProgramAddressSync(
    [Buffer.from(DELEGATION_SEED), delegator.toBuffer()],
    programId
  );
}
```

**packages/utils/src/index.ts** -- Verify getDelegationPDA is exported (governance-pda.ts barrel already exported).

**apps/web/prisma/schema.prisma** -- Add 2 new models:

```prisma
model Delegation {
  id               String    @id @default(cuid())
  onChainAddress   String    @unique
  delegatorWallet  String    @unique
  delegateWallet   String
  delegatedAmount  BigInt
  isActive         Boolean   @default(true)
  effectiveFromRound Int
  transactionSignature String @unique
  delegatedAt      DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  @@index([delegateWallet])
  @@index([isActive])
}

model HumanVerification {
  id                  String    @id @default(cuid())
  walletAddress       String    @unique
  gatekeeperNetwork   String
  verified            Boolean   @default(false)
  verifiedAt          DateTime?
  expiresAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([walletAddress])
}
```

Run `npx prisma format` to verify schema syntax. Run `npx prisma generate` to ensure client generates successfully.
  </action>
  <verify>
Run `npx prisma format` -- must complete without errors.
Run `npx prisma generate` -- must generate client successfully.
Verify new types: `grep "HumanVerificationInfo" packages/types/src/identity.ts`
Verify PDA helper: `grep "getDelegationPDA" packages/utils/src/governance-pda.ts`
Verify Prisma models: `grep "model Delegation" apps/web/prisma/schema.prisma`
  </verify>
  <done>
identity.ts types exist with HumanVerificationInfo, DelegationInfo, DelegationStats. governance.ts has 3 new GovernanceConfig fields. getDelegationPDA is exported from @gsd/utils. Prisma has Delegation and HumanVerification models. Prisma generates clean.
  </done>
</task>

</tasks>

<verification>
- `anchor build` succeeds with no errors
- All existing tests pass (no regressions from state struct changes)
- `npx prisma format` and `npx prisma generate` succeed
- New types are importable: `import { DelegationInfo } from '@gsd/types'`
- PDA derivation consistency: Rust seeds ["delegation", delegator] match TypeScript [Buffer.from("delegation"), delegator.toBuffer()]
</verification>

<success_criteria>
- GovernanceConfig has quadratic_voting_enabled, civic_gatekeeper_network, decay_half_life_days fields
- DelegationRecord PDA struct exists and compiles
- GovernanceError has 6 new delegation/sybil error codes
- TypeScript types mirror all new Rust structures
- getDelegationPDA helper exists and matches Rust PDA seeds
- Prisma Delegation and HumanVerification models exist with correct indexes
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-governance/06-01-SUMMARY.md`
</output>
