---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - apps/web/app/api/profile/route.ts
  - apps/web/app/api/profile/[wallet]/route.ts
  - apps/web/app/api/directory/route.ts
  - apps/web/app/(auth)/profile/edit/page.tsx
  - apps/web/app/(public)/profile/[wallet]/page.tsx
  - apps/web/app/(public)/explore/page.tsx
  - apps/web/components/profile/profile-form.tsx
  - apps/web/components/profile/profile-card.tsx
  - apps/web/components/profile/profile-header.tsx
  - apps/web/components/profile/developer-grid.tsx
  - apps/web/lib/anchor/use-program.ts
  - apps/web/lib/profile/actions.ts
autonomous: true

must_haves:
  truths:
    - "User can create a developer profile with display name and bio"
    - "Profile creation triggers both PostgreSQL save AND on-chain PDA registration with profile hash"
    - "User can edit their display name, bio, and external links (GitHub, Twitter/X, website)"
    - "Profile edit updates PostgreSQL and submits on-chain hash update transaction"
    - "Anyone can view a developer's public profile page at /profile/[wallet]"
    - "Anyone can browse the developer directory at /explore showing all registered developers"
    - "Directory shows total member count prominently"
    - "All public pages (directory, profiles) are accessible without wallet connection"
  artifacts:
    - path: "apps/web/app/api/profile/route.ts"
      provides: "POST (create profile) and PUT (update profile) endpoints with auth protection"
      exports: ["POST", "PUT"]
    - path: "apps/web/app/api/profile/[wallet]/route.ts"
      provides: "GET endpoint for fetching any profile by wallet address"
      exports: ["GET"]
    - path: "apps/web/app/api/directory/route.ts"
      provides: "GET endpoint for paginated developer directory"
      exports: ["GET"]
    - path: "apps/web/app/(auth)/profile/edit/page.tsx"
      provides: "Profile create/edit form page (protected route)"
      contains: "ProfileForm"
    - path: "apps/web/app/(public)/profile/[wallet]/page.tsx"
      provides: "Public profile page for any developer"
      contains: "ProfileHeader"
    - path: "apps/web/app/(public)/explore/page.tsx"
      provides: "Public developer directory with grid layout and member count"
      contains: "DeveloperGrid"
    - path: "apps/web/components/profile/profile-form.tsx"
      provides: "Form component for creating/editing profile with on-chain transaction"
      contains: "computeProfileHash"
    - path: "apps/web/lib/anchor/use-program.ts"
      provides: "React hook for Anchor program interaction"
      contains: "useProgram"
  key_links:
    - from: "apps/web/components/profile/profile-form.tsx"
      to: "apps/web/app/api/profile/route.ts"
      via: "POST/PUT fetch to save profile data to PostgreSQL"
      pattern: "fetch.*api/profile"
    - from: "apps/web/components/profile/profile-form.tsx"
      to: "programs/gsd-hub (via Anchor client)"
      via: "registerDeveloper or updateProfileHash transaction"
      pattern: "program\\.methods\\.(registerDeveloper|updateProfileHash)"
    - from: "apps/web/app/(public)/profile/[wallet]/page.tsx"
      to: "apps/web/app/api/profile/[wallet]/route.ts"
      via: "Server-side data fetch for profile rendering"
      pattern: "api/profile"
    - from: "apps/web/app/(public)/explore/page.tsx"
      to: "apps/web/app/api/directory/route.ts"
      via: "Server-side data fetch for directory listing"
      pattern: "api/directory"
    - from: "apps/web/lib/anchor/use-program.ts"
      to: "@gsd-hub/utils (getDeveloperProfilePDA)"
      via: "PDA derivation for profile transactions"
      pattern: "getDeveloperProfilePDA"
---

<objective>
Build the developer profile system: create/edit profiles with dual on-chain + off-chain storage, public profile pages, and the developer directory.

Purpose: This is the core user-facing feature of Phase 1. Creating a profile = joining the GSD community (per locked decision "Profile as movement"). The developer directory is proof the community exists and is growing (per "proof visible" strategy). The dual-write pattern (PostgreSQL + on-chain PDA hash) establishes the content-hash anchoring architecture used throughout the platform.

Output: Working profile creation/editing with on-chain PDA registration, public profile pages at /profile/[wallet], and browsable developer directory at /explore with total member count.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile API endpoints and Anchor program integration hook</name>
  <files>
    apps/web/app/api/profile/route.ts
    apps/web/app/api/profile/[wallet]/route.ts
    apps/web/app/api/directory/route.ts
    apps/web/lib/anchor/use-program.ts
    apps/web/lib/profile/actions.ts
  </files>
  <action>
    Create Anchor program React hook (apps/web/lib/anchor/use-program.ts):
    - "use client" hook
    - Uses useAnchorWallet() and useConnection() from wallet-adapter-react
    - Creates AnchorProvider from wallet + connection
    - Creates Program instance using the generated IDL and NEXT_PUBLIC_PROGRAM_ID
    - Returns { program, provider } or null if wallet not connected
    - Import IDL from the generated anchor-idl directory (copy target/idl/gsd_hub.json into apps/web/anchor-idl/ during build, or reference from target directly with appropriate path -- document the approach)

    Create profile server actions / helpers (apps/web/lib/profile/actions.ts):
    - Helper functions for profile operations that interact with Prisma:
      - getProfileByWallet(walletAddress: string): Promise<User | null>
      - createProfile(data: CreateProfileInput & { walletAddress: string }): Promise<User>
      - updateProfile(walletAddress: string, data: UpdateProfileInput): Promise<User>
      - getDirectory(page: number, limit: number): Promise<{ profiles: User[], total: number }>
    - Use types from @gsd-hub/types
    - Use prisma client from lib/db/prisma.ts
    - On create/update: compute profile hash using computeProfileHash from @gsd-hub/utils and store in profileHash field

    Create profile CRUD API (apps/web/app/api/profile/route.ts):
    - POST handler (create profile):
      1. Verify auth via auth() -- reject 401 if no session
      2. Extract walletAddress from session.publicKey
      3. Validate input: displayName (required, 3-50 chars), bio (required, 10-500 chars)
      4. Optional: githubUrl, twitterUrl, websiteUrl (validate URL format if provided)
      5. Check if profile already exists for this wallet -- reject 409 if duplicate
      6. Create profile in PostgreSQL via createProfile()
      7. Compute PDA address using getDeveloperProfilePDA from @gsd-hub/utils
      8. Store PDA address in onChainPda field
      9. Return 201 with profile data and the computed profileHash (client needs this for on-chain tx)
    - PUT handler (update profile):
      1. Verify auth -- reject 401 if no session
      2. Validate input fields (same rules as POST, all optional for partial update)
      3. Update profile in PostgreSQL via updateProfile()
      4. Return 200 with updated profile and new profileHash

    Create profile GET by wallet (apps/web/app/api/profile/[wallet]/route.ts):
    - GET handler (public, no auth required):
      1. Extract wallet from URL params
      2. Validate wallet is a valid base58 Solana address
      3. Fetch profile via getProfileByWallet()
      4. If not found, return 404
      5. Return 200 with profile data (exclude sensitive fields if any)

    Create directory API (apps/web/app/api/directory/route.ts):
    - GET handler (public, no auth required):
      1. Parse query params: page (default 1), limit (default 20, max 100)
      2. Fetch profiles via getDirectory() -- ordered by createdAt descending (newest first)
      3. Return 200 with { profiles: [...], total: number, page: number, totalPages: number }
  </action>
  <verify>
    API endpoints respond correctly:
    - `curl localhost:3000/api/directory` returns JSON with profiles array and total count
    - `curl localhost:3000/api/profile/[valid-wallet]` returns profile or 404
    - POST/PUT to /api/profile without auth returns 401
    - useProgram hook returns program instance when wallet is connected
  </verify>
  <done>
    Profile CRUD API works with auth protection on write operations and public read access. Directory API returns paginated results with total count. Anchor program hook provides program instance for on-chain transactions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Profile create/edit form with on-chain PDA registration</name>
  <files>
    apps/web/app/(auth)/profile/edit/page.tsx
    apps/web/components/profile/profile-form.tsx
  </files>
  <action>
    Create profile form component (apps/web/components/profile/profile-form.tsx):
    - "use client" component
    - Props: existingProfile?: User (if editing, pre-fill fields)
    - Form fields:
      - Display Name: required, 3-50 chars, text input
      - Bio: required, 10-500 chars, textarea
      - GitHub URL: optional, validated URL format
      - Twitter/X URL: optional, validated URL format
      - Website URL: optional, validated URL format
    - Client-side validation before submit
    - Submit flow (this is critical -- dual-write pattern):
      1. Save profile to PostgreSQL via POST /api/profile (create) or PUT /api/profile (update)
      2. If API returns success, get the profileHash from the response
      3. Convert profileHash to Uint8Array (32 bytes)
      4. If creating (no existing PDA):
         - Use useProgram hook to get program instance
         - Derive PDA using getDeveloperProfilePDA(wallet, programId) from @gsd-hub/utils
         - Call program.methods.registerDeveloper(Array.from(profileHash)).accounts({ developerProfile: pda, authority: wallet, systemProgram }).rpc()
         - This requires the user to approve an on-chain transaction (costs ~0.001 SOL rent)
      5. If updating (PDA exists):
         - Call program.methods.updateProfileHash(Array.from(newHash)).accounts({ developerProfile: pda, authority: wallet }).rpc()
      6. Show success toast with "Profile created! Welcome to GSD." or "Profile updated!"
      7. On transaction error: show error toast but note that the off-chain profile was saved (the on-chain hash can be synced later)
    - Loading states: show spinner during API call and transaction
    - Use shadcn/ui form components (Input, Label, Button, toast)

    NOTE on on-chain transactions: This requires the app to be connected to devnet and the user to have devnet SOL. Add a note in the UI: "This requires a small amount of SOL for on-chain registration (~0.001 SOL on devnet)." Include a link to a devnet SOL faucet.

    Create profile edit page (apps/web/app/(auth)/profile/edit/page.tsx):
    - Protected route (middleware handles redirect)
    - Server component that fetches existing profile data using auth() session
    - If profile exists: render ProfileForm with existingProfile prop (edit mode)
    - If no profile: render ProfileForm without existingProfile (create mode)
    - Header: "Create Your Profile" or "Edit Your Profile" depending on mode
    - Subtext: "Join the GSD community" for create, "Update your profile" for edit

    Update the dashboard page to link to /profile/edit if no profile exists yet, or show profile summary with "Edit Profile" link if profile exists.
  </action>
  <verify>
    Navigate to /profile/edit while authenticated. Fill in display name and bio. Submit. Verify: 1) Profile appears in PostgreSQL (check via Prisma Studio: `npx prisma studio`). 2) On-chain transaction appears in devnet explorer (if connected to devnet with SOL). 3) Success toast displays. Edit the profile, verify hash update works.
  </verify>
  <done>
    Profile creation and editing works with dual-write: PostgreSQL save + on-chain PDA registration (register_developer) or hash update (update_profile_hash). Form validates input, shows loading states, handles transaction errors gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Public profile pages and developer directory</name>
  <files>
    apps/web/app/(public)/profile/[wallet]/page.tsx
    apps/web/app/(public)/explore/page.tsx
    apps/web/components/profile/profile-card.tsx
    apps/web/components/profile/profile-header.tsx
    apps/web/components/profile/developer-grid.tsx
  </files>
  <action>
    Create profile header component (apps/web/components/profile/profile-header.tsx):
    - Large display of developer profile:
      - Avatar (or generated avatar from wallet address -- use a deterministic color/pattern from wallet pubkey)
      - Display name (large)
      - Bio
      - Wallet address (truncated with copy button)
      - External links as icons: GitHub, Twitter/X, Website (only shown if set)
      - Member since date
      - PDA address with link to Solana Explorer (devnet)
    - If viewing own profile: "Edit Profile" button linking to /profile/edit

    Create public profile page (apps/web/app/(public)/profile/[wallet]/page.tsx):
    - Server component (for SEO/social sharing of profiles)
    - Fetch profile from API or directly from Prisma (server-side)
    - Dynamic metadata: title = "{displayName} | GSD Community Hub", description = bio
    - If profile not found: show "Developer not found" with link to /explore
    - Render ProfileHeader
    - Placeholder section: "Contribution History" with "Coming in Phase 2" note (seeds future feature)

    Create developer card component (apps/web/components/profile/profile-card.tsx):
    - Compact card for directory grid:
      - Avatar (deterministic from wallet)
      - Display name
      - Truncated wallet address
      - Bio (first 100 chars)
      - Member since date
    - Links to /profile/[wallet] on click
    - Use shadcn/ui Card component with hover state

    Create developer grid component (apps/web/components/profile/developer-grid.tsx):
    - Responsive grid: 3 columns on desktop, 2 on tablet, 1 on mobile
    - Renders array of ProfileCard components
    - Loading skeleton state

    Create developer directory page (apps/web/app/(public)/explore/page.tsx):
    - Server component for SEO
    - Fetch directory data from API or Prisma directly (server-side)
    - Prominent member count: "{N} Developers" in large text at top
    - Subtitle: "The GSD community is growing. Join the movement."
    - DeveloperGrid with all profiles
    - Pagination if >20 developers (simple prev/next)
    - CTA at bottom: "Don't see your name? Join the Movement" with wallet connect button
    - If zero members: "Be the first to join the GSD community" message
    - This page is the MOST IMPORTANT "proof the community exists" signal. It must feel alive.

    Update header navigation:
    - "Explore" link points to /explore
    - Active state on current page

    Ensure all public pages work WITHOUT wallet connection (INFR-03, token-optional).
  </action>
  <verify>
    - Visit /explore without wallet: shows directory with member count (0 initially, populated after profiles are created)
    - Visit /profile/[wallet] without wallet: shows public profile data
    - Create a profile via /profile/edit, then verify it appears in /explore directory
    - Profile page has correct metadata (check page source for title/description)
    - Grid is responsive (check at different viewport widths)
  </verify>
  <done>
    Public developer directory at /explore shows all registered developers with prominent member count. Profile pages at /profile/[wallet] display full profile info with external links. All public pages accessible without wallet connection. Profile cards link to individual profiles. Directory feels alive with community growth messaging.
  </done>
</task>

</tasks>

<verification>
- Profile dual-write: PostgreSQL save + on-chain PDA registration both complete
- Directory shows accurate member count matching database
- Profile pages have SEO metadata (title, description)
- All public pages accessible without wallet (INFR-03)
- Profile hash in PostgreSQL matches what would be derived from profile data via computeProfileHash
- PDA address stored in User.onChainPda matches derivation from wallet + program ID
</verification>

<success_criteria>
- AUTH-04: User can create on-chain developer profile (PDA) linked to their wallet
- AUTH-05: User can set display name and bio
- AUTH-06: User can view any developer's public profile (contribution history placeholder for Phase 2)
- Profile as movement: Directory prominently shows member count and growth
- Proof visible: All profile and directory pages publicly accessible
- External links: GitHub, Twitter/X, website links on profiles (per discretion recommendation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
