---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/package.json
  - apps/web/tsconfig.json
  - apps/web/next.config.ts
  - apps/web/proxy.ts
  - apps/web/postcss.config.mjs
  - apps/web/app/globals.css
  - apps/web/app/layout.tsx
  - apps/web/app/providers.tsx
  - apps/web/app/(public)/page.tsx
  - apps/web/lib/auth/auth.ts
  - apps/web/lib/auth/siws.ts
  - apps/web/app/api/auth/[...nextauth]/route.ts
  - apps/web/app/api/auth/signin-input/route.ts
  - apps/web/lib/db/prisma.ts
  - apps/web/prisma/schema.prisma
  - apps/web/prisma/prisma.config.ts
  - apps/web/lib/anchor/provider.ts
  - apps/web/components/wallet/wallet-connect-button.tsx
  - apps/web/components/layout/header.tsx
  - apps/web/.env.local.example
autonomous: true
user_setup:
  - service: postgresql
    why: "Off-chain profile storage"
    env_vars:
      - name: DATABASE_URL
        source: "Local PostgreSQL instance or hosted provider (Neon, Supabase, Railway)"
  - service: auth-secret
    why: "JWT encryption for Auth.js"
    env_vars:
      - name: AUTH_SECRET
        source: "Generate with: openssl rand -hex 32"

must_haves:
  truths:
    - "User can see a landing page without connecting a wallet"
    - "User can connect Phantom/Solflare/Backpack wallet via Wallet Standard auto-detect"
    - "User can authenticate via SIWS (Sign In With Solana) and receive a JWT session"
    - "User session persists across browser refresh via HTTP-only cookie"
    - "Disconnecting wallet clears the session"
  artifacts:
    - path: "apps/web/lib/auth/auth.ts"
      provides: "Auth.js v5 configuration with SIWS Credentials provider"
      exports: ["auth", "handlers", "signIn", "signOut"]
    - path: "apps/web/lib/auth/siws.ts"
      provides: "SIWS helper functions for creating sign-in input and verifying output"
      exports: ["createSignInInput", "verifySIWS"]
    - path: "apps/web/app/providers.tsx"
      provides: "Client providers wrapping wallet, auth session, and React Query"
      contains: "WalletProvider"
    - path: "apps/web/proxy.ts"
      provides: "Next.js 16 proxy for route protection (NOT middleware.ts)"
      contains: "proxy"
    - path: "apps/web/prisma/schema.prisma"
      provides: "User model with walletAddress, profile fields, and timestamps"
      contains: "model User"
    - path: "apps/web/lib/db/prisma.ts"
      provides: "Prisma 7 client singleton with PrismaPg driver adapter"
      contains: "PrismaPg"
  key_links:
    - from: "apps/web/components/wallet/wallet-connect-button.tsx"
      to: "apps/web/lib/auth/siws.ts"
      via: "SIWS sign-in flow on wallet connect"
      pattern: "createSignInInput|verifySIWS"
    - from: "apps/web/lib/auth/auth.ts"
      to: "apps/web/lib/auth/siws.ts"
      via: "Credentials provider authorize calls verifySIWS"
      pattern: "verifySIWS"
    - from: "apps/web/lib/auth/auth.ts"
      to: "apps/web/lib/db/prisma.ts"
      via: "Upsert user record on successful auth"
      pattern: "prisma\\.user\\.(upsert|findUnique|create)"
    - from: "apps/web/proxy.ts"
      to: "apps/web/lib/auth/auth.ts"
      via: "Auth guard for protected routes"
      pattern: "auth.*proxy"
---

<objective>
Set up the Next.js 16 web application with wallet connection, SIWS authentication, database, and Anchor client -- the complete web foundation that profile features (Plan 03) and transparency page (Plan 04) build upon.

Purpose: This plan delivers the core web infrastructure: a user can visit the site, connect their wallet, authenticate via SIWS, and have their session persist. Without this, no interactive features are possible.
Output: Working Next.js 16 app with wallet auth flow, Prisma 7 database, and Anchor program client.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 16 app with wallet providers, Tailwind CSS 4, and Prisma 7 database</name>
  <files>
    apps/web/package.json
    apps/web/tsconfig.json
    apps/web/next.config.ts
    apps/web/postcss.config.mjs
    apps/web/app/globals.css
    apps/web/app/layout.tsx
    apps/web/app/providers.tsx
    apps/web/app/(public)/page.tsx
    apps/web/lib/db/prisma.ts
    apps/web/prisma/schema.prisma
    apps/web/prisma/prisma.config.ts
    apps/web/lib/anchor/provider.ts
    apps/web/components/layout/header.tsx
    apps/web/.env.local.example
  </files>
  <action>
    Create the Next.js 16 web application inside apps/web/:

    1. `package.json`: name "web", type "module", dependencies:
       - next@16, react@19, react-dom@19
       - @solana/web3.js@1, @coral-xyz/anchor@0.32.1
       - @solana/wallet-adapter-base, @solana/wallet-adapter-react, @solana/wallet-adapter-react-ui
       - @solana/wallet-standard-features, @solana/wallet-standard-util
       - next-auth@5 (Auth.js v5)
       - @prisma/client, @prisma/adapter-pg
       - zustand@5, @tanstack/react-query@5
       - bs58, tweetnacl
       - @gsd/types (workspace:*), @gsd/utils (workspace:*)
       - buffer, crypto-browserify, stream-browserify (polyfills)
       DevDependencies: typescript, @types/react, @types/node, tailwindcss@4, @tailwindcss/postcss, postcss, prisma, eslint

    2. `next.config.ts`: Enable turbopack resolveAlias for buffer/crypto/stream polyfills (see research Pattern - Pitfall 1). Enable reactCompiler: true. Set transpilePackages: ["@gsd/types", "@gsd/utils"].

    3. `postcss.config.mjs`: Configure with @tailwindcss/postcss plugin (Tailwind CSS 4 pattern).

    4. `app/globals.css`: Use `@import "tailwindcss"` (Tailwind CSS 4 syntax, not @tailwind directives). Add `@theme` block with GSD brand colors -- use a professional dark theme (slate/zinc base with an accent color like emerald or cyan that conveys "developer tool, not memecoin"). Define CSS variables for the theme.

    5. `app/layout.tsx`: Root layout with metadata (title: "GSD Community Hub", description reflecting the "open source, real utility" brand). Import globals.css. Wrap children with AppProviders. Include Header component.

    6. `app/providers.tsx`: "use client" component wrapping children with:
       - `ConnectionProvider` (endpoint from NEXT_PUBLIC_RPC_URL or devnet fallback)
       - `WalletProvider` with `wallets={[]}` (Wallet Standard auto-detect -- no manual adapter imports)
       - `WalletModalProvider`
       - `SessionProvider` (from next-auth/react for Auth.js v5)
       - `QueryClientProvider` (TanStack Query)
       - Import `@solana/wallet-adapter-react-ui/styles.css`
       - Add Buffer polyfill: `import { Buffer } from 'buffer'; if (typeof window !== 'undefined') globalThis.Buffer = Buffer;`

    7. `app/(public)/page.tsx`: Simple landing page (Server Component). Headline: "GSD Community Hub" with tagline "Open Source. Real Utility. For All. For Ever." Brief description of what the platform does. "Join the Movement" CTA button linking to wallet connect. Show this is a real, working platform -- no "coming soon" vibes.

    8. `components/layout/header.tsx`: "use client" component with site logo/name, navigation links (Explore, Transparency), and the WalletMultiButton (from @solana/wallet-adapter-react-ui) on the right side. Show session status (connected wallet address truncated) when authenticated.

    9. `prisma/schema.prisma`: Prisma 7 format:
       - generator: provider = "prisma-client", output = "./generated/prisma"
       - datasource: provider = "postgresql" (no url -- configured in prisma.config.ts)
       - Model `User`: id (cuid), walletAddress (String, @unique), displayName (String?, @db.VarChar(50)), bio (String?, @db.VarChar(500)), avatarUrl (String?), githubUrl (String?), twitterUrl (String?), websiteUrl (String?), profileHash (String?), onChainPda (String?), createdAt (DateTime, @default(now())), updatedAt (DateTime, @updatedAt). Index on walletAddress.
       - Model `ProgramUpgrade`: id (cuid), programId (String), version (String), description (String), signers (String[]), transactionSignature (String), multisigAddress (String), createdAt (DateTime). This supports the locked "public changelog" decision.

    10. `prisma/prisma.config.ts`: Prisma 7 config with defineConfig, env('DATABASE_URL'), migration path.

    11. `lib/db/prisma.ts`: Prisma 7 singleton with PrismaPg driver adapter. Import from generated output path './../../prisma/generated/prisma/client'. Global singleton pattern for dev hot-reload.

    12. `lib/anchor/provider.ts`: Export `useAnchorProvider()` hook that creates an AnchorProvider from useConnection() and useAnchorWallet(). Export `useGsdProgram()` hook that creates a Program instance from the IDL. Read NEXT_PUBLIC_PROGRAM_ID from env. Handle case where wallet is not connected (return null).

    13. `.env.local.example`: Template with all required env vars:
        - AUTH_SECRET, AUTH_URL
        - NEXT_PUBLIC_RPC_URL, NEXT_PUBLIC_PROGRAM_ID, NEXT_PUBLIC_NETWORK
        - DATABASE_URL

    Run `pnpm install` from root. Run `npx prisma generate` in apps/web to generate Prisma client. Run `npx prisma db push` to create tables (requires DATABASE_URL). Initialize shadcn/ui: `npx shadcn@latest init` then add button, card, avatar, input, label, toast components.

    IMPORTANT: Use proxy.ts (NOT middleware.ts) -- this is Next.js 16. Use AUTH_SECRET (NOT NEXTAUTH_SECRET). Use `import { auth } from "@/lib/auth/auth"` pattern (NOT getServerSession).
  </action>
  <verify>
    - `pnpm install` succeeds from root
    - `npx prisma generate` in apps/web produces generated client
    - `cd apps/web && pnpm dev` starts the dev server without errors
    - Visit http://localhost:3000 -- landing page renders
    - Wallet connect button appears in header (even if no wallet extension installed, the button should render)
  </verify>
  <done>
    Next.js 16 app runs on localhost:3000 with landing page, wallet provider (auto-detecting installed wallets), Prisma 7 database with User and ProgramUpgrade models, Anchor program client hooks, and Tailwind CSS 4 styling. The app renders without errors and the wallet connect button is visible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SIWS authentication with Auth.js v5 and session persistence</name>
  <files>
    apps/web/lib/auth/auth.ts
    apps/web/lib/auth/siws.ts
    apps/web/app/api/auth/[...nextauth]/route.ts
    apps/web/app/api/auth/signin-input/route.ts
    apps/web/components/wallet/wallet-connect-button.tsx
    apps/web/proxy.ts
  </files>
  <action>
    Implement the full SIWS authentication flow:

    1. `lib/auth/siws.ts`: SIWS helper module:
       - `createSignInInput(domain: string, nonce: string)`: Returns a `SolanaSignInInput` object with domain, statement ("Sign in to GSD Community Hub"), nonce (from CSRF token), issuedAt (ISO timestamp), expirationTime (10 minutes from now). Import types from @solana/wallet-standard-features.
       - `verifySIWS(inputSerialized: string, outputSerialized: string)`: Deserializes the stringified SolanaSignInInput and SolanaSignInOutput, calls `verifySignIn(input, output)` from @solana/wallet-standard-util. Returns the public key string on success, null on failure. Handle Uint8Array deserialization (wallet-standard uses Uint8Array, Auth.js credentials are strings -- need base64 or JSON serialization bridge).
       - IMPORTANT: The serialization bridge is a known complexity area (Research Open Question 2). Serialize Uint8Array fields as base64 strings for transport through Auth.js credentials. Deserialize back to Uint8Array before calling verifySignIn.

    2. `lib/auth/auth.ts`: Auth.js v5 configuration:
       - Import NextAuth from "next-auth", Credentials from "next-auth/providers/credentials"
       - Export `{ auth, handlers, signIn, signOut }` from NextAuth({...})
       - Credentials provider with credentials: { message: {type: "text"}, signature: {type: "text"}, publicKey: {type: "text"}, input: {type: "text"}, output: {type: "text"} }
       - authorize function: call verifySIWS with serialized input/output. If valid, upsert User in database (create if first login, update lastLogin otherwise). Return { id: publicKey } on success, null on failure.
       - session strategy: "jwt", maxAge: 24 * 60 * 60 (24 hours per research recommendation)
       - callbacks.jwt: Store publicKey in token
       - callbacks.session: Expose publicKey on session object
       - pages: { signIn: "/" } (redirect to home, not a separate sign-in page)
       - Use AUTH_SECRET env var (NOT NEXTAUTH_SECRET)

    3. `app/api/auth/[...nextauth]/route.ts`: Export `{ GET, POST }` from handlers (standard Auth.js v5 catch-all route).

    4. `app/api/auth/signin-input/route.ts`: GET endpoint that returns a fresh SolanaSignInInput. Generate nonce (crypto.randomUUID or similar), include domain from AUTH_URL env var. This is called by the frontend before initiating SIWS.

    5. `components/wallet/wallet-connect-button.tsx`: "use client" custom wallet button component:
       - Uses useWallet() from @solana/wallet-adapter-react
       - On wallet connect: fetch sign-in input from /api/auth/signin-input, check if wallet supports signIn feature (from @solana/wallet-standard-features), call wallet.signIn(input), serialize the output, POST to Auth.js credentials endpoint via signIn("credentials", ...) from next-auth/react
       - If wallet does NOT support signIn feature: fall back to signMessage with a manually constructed SIWS message, then POST to credentials endpoint. Use tweetnacl for signature verification in fallback path.
       - On disconnect: call signOut() from next-auth/react to clear the session
       - Show wallet address (truncated) when connected and authenticated
       - Show "Sign In" when wallet connected but not authenticated
       - Show WalletMultiButton when not connected

    6. `proxy.ts` (NOT middleware.ts): Export auth as proxy for route protection. Match on `/(auth)/:path*` and `/api/profile/:path*`. This is Next.js 16 -- the file MUST be named proxy.ts and the export MUST be named proxy. Use Node.js runtime (not edge).

    CRITICAL SECURITY:
    - Verify nonce is single-use (consumed on verification) to prevent replay attacks
    - Verify domain matches AUTH_URL to prevent phishing
    - Verify issuedAt and expirationTime to prevent stale signatures
    - JWT stored in HTTP-only secure cookie (Auth.js handles this automatically)
    - Never expose AUTH_SECRET to client
  </action>
  <verify>
    - Dev server starts: `cd apps/web && pnpm dev`
    - With Phantom/Solflare/Backpack installed: click wallet button, connect wallet, approve SIWS message, verify JWT cookie is set (check browser DevTools > Application > Cookies)
    - Refresh browser: session persists (user still appears authenticated in header)
    - Click disconnect: session is cleared, cookie removed
    - Without wallet extension: wallet button shows connect modal (no crash)
    - Check Network tab: /api/auth/signin-input returns valid SolanaSignInInput JSON
  </verify>
  <done>
    Complete SIWS authentication flow works: user connects wallet, signs SIWS message (one-click via Wallet Standard signIn), receives JWT session cookie (24h expiry, HTTP-only), session persists across browser refresh, disconnecting clears session. Auth.js v5 configured with Credentials provider. Protected routes guarded by proxy.ts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm dev` in apps/web starts without errors
2. Landing page renders at http://localhost:3000 with wallet connect button
3. Wallet connection triggers SIWS flow
4. After authentication, session persists across page refresh
5. Wallet disconnect clears session
6. Protected routes redirect to home when not authenticated
7. Database has User table with correct schema
</verification>

<success_criteria>
- Next.js 16 app runs with Turbopack (no polyfill errors)
- Wallet Standard auto-detects installed wallets (Phantom, Solflare, Backpack)
- SIWS authentication produces a valid JWT session in HTTP-only cookie
- Session persists across browser refresh (AUTH-03)
- Prisma 7 with PrismaPg adapter connects to PostgreSQL
- proxy.ts guards authenticated routes
- No token references or $GSD balance display (INFR-03 compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
