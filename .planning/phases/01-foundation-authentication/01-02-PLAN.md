---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/package.json
  - apps/web/tsconfig.json
  - apps/web/next.config.ts
  - apps/web/postcss.config.mjs
  - apps/web/app/globals.css
  - apps/web/tailwind.config.ts
  - apps/web/app/layout.tsx
  - apps/web/app/providers.tsx
  - apps/web/components/ui/button.tsx
  - apps/web/components/ui/card.tsx
  - apps/web/components/ui/input.tsx
  - apps/web/components/ui/label.tsx
  - apps/web/components/ui/dialog.tsx
  - apps/web/components/ui/toast.tsx
  - apps/web/components/ui/avatar.tsx
  - apps/web/components/ui/dropdown-menu.tsx
  - apps/web/components/layout/header.tsx
  - apps/web/components/layout/footer.tsx
  - apps/web/components/wallet/wallet-button.tsx
  - apps/web/lib/anchor/provider.ts
  - apps/web/lib/solana/connection.ts
  - apps/web/lib/db/prisma.ts
  - apps/web/lib/auth/config.ts
  - apps/web/app/api/auth/[...nextauth]/route.ts
  - apps/web/app/api/auth/signin-input/route.ts
  - apps/web/middleware.ts
  - apps/web/prisma/schema.prisma
  - apps/web/.env.example
autonomous: true

must_haves:
  truths:
    - "User can visit the site and see a landing page without connecting a wallet"
    - "User can connect Phantom/Solflare/Backpack wallet via the Wallet Standard modal"
    - "User can authenticate via SIWS one-click sign-in"
    - "JWT session persists across browser refresh (HTTP-only cookie, 24h expiry)"
    - "Protected routes (/dashboard, /profile/edit) redirect unauthenticated users"
    - "PostgreSQL User model exists with wallet_address, display_name, bio, links, profile_hash fields"
  artifacts:
    - path: "apps/web/app/providers.tsx"
      provides: "Client providers: ConnectionProvider, WalletProvider (wallets=[]), WalletModalProvider, SessionProvider, QueryClientProvider"
      contains: "wallets={[]}"
    - path: "apps/web/lib/auth/config.ts"
      provides: "Auth.js v5 configuration with SIWS Credentials provider"
      contains: "verifySignIn"
    - path: "apps/web/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js route handlers"
      exports: ["GET", "POST"]
    - path: "apps/web/app/api/auth/signin-input/route.ts"
      provides: "SIWS nonce/input generation endpoint"
      exports: ["GET"]
    - path: "apps/web/middleware.ts"
      provides: "Auth middleware protecting /dashboard and /profile/edit routes"
      contains: "matcher"
    - path: "apps/web/prisma/schema.prisma"
      provides: "User model with wallet_address unique, display_name, bio, links, profile_hash, on_chain_pda"
      contains: "model User"
    - path: "apps/web/next.config.ts"
      provides: "Next.js 16 config with Turbopack polyfill resolution for Solana web3.js"
      contains: "turbopack"
  key_links:
    - from: "apps/web/components/wallet/wallet-button.tsx"
      to: "apps/web/lib/auth/config.ts"
      via: "SIWS signIn flow: wallet signs -> POST to Auth.js credentials endpoint"
      pattern: "signIn.*credentials"
    - from: "apps/web/lib/auth/config.ts"
      to: "@solana/wallet-standard-util"
      via: "verifySignIn() validates SIWS signature server-side"
      pattern: "verifySignIn"
    - from: "apps/web/middleware.ts"
      to: "apps/web/lib/auth/config.ts"
      via: "Auth middleware using exported auth function"
      pattern: "auth.*middleware"
    - from: "apps/web/app/layout.tsx"
      to: "apps/web/app/providers.tsx"
      via: "Root layout wraps children with AppProviders"
      pattern: "AppProviders"
---

<objective>
Build the Next.js web application with wallet connection, SIWS authentication, database schema, and protected routing.

Purpose: This is the web application layer that users interact with. It wires together wallet connection (Wallet Standard auto-detect), SIWS authentication (Auth.js v5 + Credentials provider), JWT session management (HTTP-only cookies, 24h expiry), and the PostgreSQL database. After this plan, users can connect their wallet, authenticate, and have a persistent session -- the prerequisite for all profile and directory features.

Output: Working Next.js app at localhost:3000 with wallet connect modal, SIWS sign-in, persistent sessions, database schema ready, and protected routes.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js app scaffold with Solana wallet providers and Turbopack config</name>
  <files>
    apps/web/package.json
    apps/web/tsconfig.json
    apps/web/next.config.ts
    apps/web/postcss.config.mjs
    apps/web/app/globals.css
    apps/web/tailwind.config.ts
    apps/web/app/layout.tsx
    apps/web/app/providers.tsx
    apps/web/app/(public)/page.tsx
    apps/web/components/ui/button.tsx
    apps/web/components/layout/header.tsx
    apps/web/components/layout/footer.tsx
    apps/web/components/wallet/wallet-button.tsx
    apps/web/lib/solana/connection.ts
    apps/web/lib/anchor/provider.ts
    apps/web/lib/db/prisma.ts
    apps/web/prisma/schema.prisma
    apps/web/.env.example
  </files>
  <action>
    Initialize the Next.js 16 app in apps/web/:
    - package.json with dependencies: next@16, react@19, react-dom@19, @solana/web3.js@1, @coral-xyz/anchor@0.32.1, @solana/wallet-adapter-base, @solana/wallet-adapter-react, @solana/wallet-adapter-react-ui, @solana/wallet-standard-features, @solana/wallet-standard-util, next-auth@5, @prisma/client, zustand@5, @tanstack/react-query@5, bs58, tweetnacl
    - Dev dependencies: typescript, @types/react, @types/node, tailwindcss@4, @tailwindcss/postcss, postcss, prisma, eslint
    - Add workspace dependency on @gsd-hub/types and @gsd-hub/utils
    - tsconfig.json extending root, with paths alias "@/*" -> "./src/*" or "./*"

    Configure Next.js 16 (next.config.ts):
    - Enable Turbopack (default in Next.js 16)
    - Add turbopack.resolveAlias for Node.js polyfills needed by @solana/web3.js v1:
      - "crypto": "crypto-browserify" (or empty module if not needed browser-side)
      - Resolve Buffer polyfill: ensure `buffer` package is available
    - Configure webpack fallback as backup if Turbopack has issues
    - Set serverExternalPackages for prisma if needed
    - NOTE: The exact polyfill config may need iteration. Start with minimal config and add polyfills as build errors indicate. Document what works.

    Set up Tailwind CSS 4:
    - postcss.config.mjs with @tailwindcss/postcss
    - app/globals.css with @import "tailwindcss" and @theme block for GSD brand colors:
      - Primary: bold, energetic color (e.g., electric blue or vibrant green -- something that says "builders, not traders")
      - Background: dark theme (dark-900 base) -- crypto-native feel
      - Accent: warm highlight for CTAs
    - Install shadcn/ui: `npx shadcn@latest init` then add button, card, input, label, dialog, toast, avatar, dropdown-menu components

    Create providers (apps/web/app/providers.tsx):
    - "use client" component
    - ConnectionProvider with endpoint from NEXT_PUBLIC_RPC_URL env var (fallback to devnet clusterApiUrl)
    - WalletProvider with wallets={[]} for Wallet Standard auto-detect, autoConnect=true
    - WalletModalProvider wrapping children
    - SessionProvider from next-auth/react for auth session
    - QueryClientProvider from @tanstack/react-query

    Create root layout (apps/web/app/layout.tsx):
    - HTML with dark theme class
    - AppProviders wrapping children
    - Header and Footer components
    - Metadata: title "GSD Community Hub", description per brand

    Create header component (apps/web/components/layout/header.tsx):
    - GSD logo/wordmark on left
    - Navigation: Explore (directory), Transparency
    - WalletButton on right (connect/disconnect)
    - When authenticated: show truncated wallet address, dropdown with Dashboard, Profile, Sign Out

    Create wallet button component (apps/web/components/wallet/wallet-button.tsx):
    - "use client" component
    - Uses useWallet() hook for connection state
    - When disconnected: renders WalletMultiButton from wallet-adapter-react-ui (standard modal)
    - When connected but not authenticated: triggers SIWS sign-in flow automatically
    - When authenticated: shows address with dropdown menu

    Create lib/solana/connection.ts:
    - Export a helper to get Connection instance from env var

    Create lib/anchor/provider.ts:
    - Export helper to create AnchorProvider from useAnchorWallet() + connection
    - Export program ID constant from env var NEXT_PUBLIC_PROGRAM_ID

    Create lib/db/prisma.ts:
    - Singleton Prisma client (handle hot reload in development)
    - Standard pattern: globalThis.__prisma || new PrismaClient()

    Create Prisma schema (apps/web/prisma/schema.prisma):
    - generator client with prisma-client-js provider
    - datasource db with postgresql provider, url from DATABASE_URL env
    - Model User:
      - id: String @id @default(cuid())
      - walletAddress: String @unique
      - displayName: String? @db.VarChar(50)
      - bio: String? @db.VarChar(500)
      - avatarUrl: String?
      - githubUrl: String?
      - twitterUrl: String?
      - websiteUrl: String?
      - profileHash: String? (SHA-256 matching on-chain PDA)
      - onChainPda: String? (PDA address for quick lookup)
      - createdAt: DateTime @default(now())
      - updatedAt: DateTime @updatedAt
      - @@index([walletAddress])

    Create .env.example with all required env vars (AUTH_SECRET, AUTH_URL, NEXT_PUBLIC_RPC_URL, NEXT_PUBLIC_PROGRAM_ID, NEXT_PUBLIC_NETWORK, DATABASE_URL)

    Create a minimal landing page at app/(public)/page.tsx:
    - Hero: "GSD Community Hub" with tagline "Open Source. Real Utility. For All. For Ever."
    - Subtitle: "Connect your wallet. Join the movement. Ship together."
    - CTA button: "Join the Movement" -> triggers wallet connect
    - Stats placeholder (will show member count once directory exists)
    - The page must be visually appealing and feel like joining a movement, not signing up for a service

    Run `pnpm install` at root, then `pnpm --filter web dev` to verify the app starts without errors.
  </action>
  <verify>
    `pnpm install` succeeds. `pnpm --filter web dev` starts Next.js at localhost:3000 without build errors. The landing page renders. The wallet connect button appears. Clicking it opens the Wallet Standard modal showing installed wallets. `npx prisma generate` succeeds (schema is valid). No Node.js polyfill errors in console.
  </verify>
  <done>
    Next.js app runs at localhost:3000 with wallet connect modal working via Wallet Standard, dark-themed landing page with GSD branding, Prisma schema generated, all providers wired correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: SIWS authentication with Auth.js v5, JWT sessions, and route protection</name>
  <files>
    apps/web/lib/auth/config.ts
    apps/web/app/api/auth/[...nextauth]/route.ts
    apps/web/app/api/auth/signin-input/route.ts
    apps/web/middleware.ts
    apps/web/components/wallet/wallet-button.tsx
    apps/web/app/(auth)/dashboard/page.tsx
  </files>
  <action>
    Create SIWS sign-in input endpoint (apps/web/app/api/auth/signin-input/route.ts):
    - GET handler that generates SolanaSignInInput:
      - domain: from request headers or AUTH_URL env var
      - statement: "Sign in to GSD Community Hub"
      - nonce: crypto.randomUUID() -- unique per request to prevent replay
      - issuedAt: new Date().toISOString()
      - expirationTime: 10 minutes from now
    - Return as JSON

    Create Auth.js v5 configuration (apps/web/lib/auth/config.ts):
    - Use Auth.js v5 patterns (NOT v4):
      - Export { auth, handlers, signIn, signOut } from NextAuth({...})
      - Use AUTH_SECRET env var (NOT NEXTAUTH_SECRET)
    - Credentials provider named "solana":
      - credentials: { message: {type: "text"}, signature: {type: "text"}, publicKey: {type: "text"} }
      - authorize function:
        1. Deserialize the signed message and signature from the credentials
        2. Verify the signature using @solana/wallet-standard-util verifySignIn if using Wallet Standard signIn output format
        3. As fallback (for wallets not supporting signIn), verify using tweetnacl.sign.detached.verify with the raw message bytes and signature bytes
        4. Verify the domain in the message matches AUTH_URL
        5. If valid, return { id: publicKey, name: publicKey } -- the publicKey is the user identifier
        6. If invalid, return null (Auth.js sends 401)
    - Session config: strategy "jwt", maxAge 24 * 60 * 60 (24 hours)
    - JWT callback: if user exists (fresh sign-in), store user.id as token.publicKey
    - Session callback: expose publicKey on session object (session.publicKey = token.publicKey)
    - Pages: signIn disabled (we use custom wallet flow, not Auth.js pages)

    IMPORTANT Auth.js v5 notes (per research pitfalls):
    - Use auth() function, NOT getServerSession()
    - Use AUTH_SECRET, NOT NEXTAUTH_SECRET
    - Import from "@/lib/auth/config", not from "next-auth"

    Create Auth.js route handler (apps/web/app/api/auth/[...nextauth]/route.ts):
    - Import { handlers } from "@/lib/auth/config"
    - Export const { GET, POST } = handlers

    Update wallet button (apps/web/components/wallet/wallet-button.tsx):
    - After wallet connects, check if wallet supports the signIn feature (SolanaSignIn from @solana/wallet-standard-features)
    - If supported (Wallet Standard signIn):
      1. Fetch SolanaSignInInput from /api/auth/signin-input
      2. Call wallet.features[SolanaSignIn].signIn(input)
      3. Receive SolanaSignInOutput { account, signedMessage, signature }
      4. POST to Auth.js signIn("solana", { message: serialize(signedMessage), signature: serialize(signature), publicKey: account.address })
    - If NOT supported (legacy wallet):
      1. Fetch sign-in input from /api/auth/signin-input
      2. Construct SIWS message manually
      3. Call wallet.signMessage() with the message bytes
      4. POST to Auth.js with the message and signature
    - On successful auth: TanStack Query invalidation, redirect to /dashboard
    - On disconnect: call signOut() from next-auth/react to clear session

    Create middleware (apps/web/middleware.ts):
    - Export auth as middleware from the auth config
    - config.matcher protects: /dashboard/:path*, /profile/edit/:path*, /api/profile (POST/PUT/DELETE but not GET)
    - Unauthenticated requests to protected routes redirect to / (landing page)

    Create placeholder dashboard page (apps/web/app/(auth)/dashboard/page.tsx):
    - Server component using auth() to get session
    - Show "Welcome, {truncated wallet address}"
    - Show "Your profile" card with link to create/edit profile (placeholder for Plan 03)
    - This is a protected route -- only accessible when authenticated

    Run the database migration: `npx prisma db push` (for development, db push is faster than migrate)

    Test the full auth flow manually:
    1. Visit localhost:3000 -- landing page visible without wallet
    2. Click wallet connect -- modal appears
    3. Connect wallet -- SIWS prompt appears
    4. Approve sign-in -- redirected to /dashboard
    5. Refresh page -- session persists (JWT cookie)
    6. Visit /dashboard directly without auth -- redirects to /

    NOTE: Testing SIWS requires a browser wallet extension (Phantom, Solflare, or Backpack). The dev server must be running. If wallet standard signIn is not available in the test wallet, the fallback signMessage path should work.
  </action>
  <verify>
    The auth flow works end-to-end: wallet connect -> SIWS sign -> JWT session created -> session persists on refresh. Protected routes (/dashboard) are only accessible when authenticated. `curl localhost:3000/api/auth/signin-input` returns valid SolanaSignInInput JSON with nonce and domain. Middleware redirects unauthenticated requests to /.
  </verify>
  <done>
    SIWS authentication works with Auth.js v5 Credentials provider. JWT session (24h, HTTP-only cookie) persists across refresh. Protected routes redirect unauthenticated users. Both Wallet Standard signIn and legacy signMessage paths are handled.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web dev` starts without errors
- Wallet connect modal shows installed wallets (Wallet Standard auto-detect)
- SIWS auth creates JWT session visible in browser cookies
- Session contains publicKey and survives page refresh
- /dashboard is protected, / and /explore are public
- Prisma schema generates valid client with User model
- No console errors related to Node.js polyfills (Buffer, crypto)
</verification>

<success_criteria>
- AUTH-01: User can connect Phantom/Solflare/Backpack via Wallet Standard modal
- AUTH-02: User authenticates via SIWS (one-click signIn or fallback signMessage)
- AUTH-03: Session persists across browser refresh (JWT cookie, 24h expiry)
- INFR-03: Landing page and public routes accessible without wallet (token-optional)
- Database schema ready for profile data (User model with all fields)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
