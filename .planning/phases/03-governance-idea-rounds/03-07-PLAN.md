---
phase: 03-governance-idea-rounds
plan: 07
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - apps/web/lib/treasury/client.ts
  - apps/web/app/api/treasury/route.ts
  - apps/web/app/(public)/treasury/page.tsx
  - apps/web/components/treasury/TreasuryDashboard.tsx
  - apps/web/components/treasury/TransactionList.tsx
autonomous: false

must_haves:
  truths:
    - "Treasury dashboard shows SOL and $GSD token balances in real-time"
    - "Dashboard shows transaction history categorized as inflows and outflows"
    - "All treasury data is sourced from on-chain (RPC + Helius API)"
    - "Dashboard is publicly accessible without authentication"
  artifacts:
    - path: "apps/web/lib/treasury/client.ts"
      provides: "Treasury RPC query functions for balances and transaction history"
      exports: ["getTreasuryBalance", "getTreasuryTransactions"]
    - path: "apps/web/app/api/treasury/route.ts"
      provides: "GET /api/treasury -- treasury balance and recent transactions"
      exports: ["GET"]
    - path: "apps/web/app/(public)/treasury/page.tsx"
      provides: "Public treasury dashboard page"
      min_lines: 40
    - path: "apps/web/components/treasury/TreasuryDashboard.tsx"
      provides: "Balance display with SOL and $GSD amounts"
      min_lines: 30
    - path: "apps/web/components/treasury/TransactionList.tsx"
      provides: "Transaction history with inflow/outflow categorization"
      min_lines: 30
  key_links:
    - from: "apps/web/app/api/treasury/route.ts"
      to: "apps/web/lib/treasury/client.ts"
      via: "getTreasuryBalance and getTreasuryTransactions calls"
      pattern: "getTreasuryBalance|getTreasuryTransactions"
    - from: "apps/web/app/(public)/treasury/page.tsx"
      to: "/api/treasury"
      via: "server-side fetch or direct RPC call"
      pattern: "api/treasury|getTreasuryBalance"
---

<objective>
Build the treasury dashboard showing real-time SOL and $GSD balances, inflows, outflows, and transaction history sourced from on-chain data.

Purpose: Satisfies TRSY-03 (dashboard shows treasury balance, inflows, outflows, and burn totals in real-time, with all transactions visible on-chain). Burn tracking is deferred to Phase 4 when the burn mechanism is built -- show placeholder for now.

Output: Treasury RPC client library, API endpoint, public dashboard page with 2 components.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-governance-idea-rounds/03-RESEARCH.md

@apps/web/app/(public)/transparency/page.tsx
@apps/web/lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create treasury RPC client and API endpoint</name>
  <files>
    apps/web/lib/treasury/client.ts
    apps/web/app/api/treasury/route.ts
  </files>
  <action>
    1. Create `apps/web/lib/treasury/client.ts`:
       - Import `Connection, PublicKey` from `@solana/web3.js`
       - Export `TREASURY_ADDRESS` from env (`process.env.NEXT_PUBLIC_TREASURY_ADDRESS`) or fallback to the Squads multisig vault PDA from transparency config
       - Export `GSD_MINT_ADDRESS` from env (`process.env.NEXT_PUBLIC_GSD_MINT`) or fallback to "8116V1BW9zaXUM6pVhWVaAduKrLcEBi3RGXedKTrBAGS"

       - `getTreasuryBalance(connection: Connection)`:
         - Get SOL balance via `connection.getBalance(treasuryPda)`
         - Get $GSD token balance via `connection.getTokenAccountsByOwner(treasuryPda, { mint: gsdMint })`
         - Parse token account data: amount at offset 64, 8 bytes LE (BigUInt64LE)
         - Return `{ solBalance: number (in SOL, divide lamports by 1e9), gsdBalance: string (BigInt as string), lastUpdated: new Date() }`
         - Handle errors: if account not found, return 0 balances

       - `getTreasuryTransactions(treasuryAddress: string, apiKey: string, limit?: number)`:
         - Call Helius Enhanced Transactions API:
           `https://api.helius.xyz/v0/addresses/${treasuryAddress}/transactions?api-key=${apiKey}&type=TRANSFER&limit=${limit || 20}`
         - Parse response into `TreasuryTransaction[]`:
           - For each transaction, determine if inflow (treasury received) or outflow (treasury sent) by checking if treasury address appears in source or destination
           - Extract amount, token type (SOL or GSD based on token transfers vs native), timestamp
         - Handle API errors gracefully (return empty array)

    2. Create `GET /api/treasury` (apps/web/app/api/treasury/route.ts):
       - Import `Connection` from `@solana/web3.js`
       - Import treasury client functions
       - Create connection to Solana cluster (`process.env.NEXT_PUBLIC_RPC_URL` or devnet default)
       - Call `getTreasuryBalance` and `getTreasuryTransactions`
       - Return: `{ balance: TreasuryBalance, transactions: TreasuryTransaction[], burnTotal: "0" }`
       - `burnTotal` is "0" placeholder -- Phase 4 implements burn tracking
       - Cache response for 30 seconds using Next.js revalidation or manual cache header
       - Handle Helius API key missing: return balance-only (transactions empty) with warning
       - Env: `HELIUS_API_KEY` for transaction history
  </action>
  <verify>Run `cd apps/web && npx tsc --noEmit` to verify compilation. If RPC_URL and HELIUS_API_KEY are set, `curl http://localhost:3000/api/treasury` returns balance data.</verify>
  <done>Treasury client fetches SOL and $GSD balances via RPC, transaction history via Helius API. API endpoint returns combined treasury data. Compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create treasury dashboard page and components</name>
  <files>
    apps/web/app/(public)/treasury/page.tsx
    apps/web/components/treasury/TreasuryDashboard.tsx
    apps/web/components/treasury/TransactionList.tsx
  </files>
  <action>
    1. `TreasuryDashboard.tsx` -- Balance display component:
       - "use client" directive
       - Props: `initialBalance?: TreasuryBalance`
       - TanStack Query fetching from `/api/treasury` with 30-second refetch interval
       - Display cards:
         a. SOL Balance: large number with SOL icon, formatted to 4 decimal places
         b. $GSD Balance: large number with token symbol, formatted with commas
         c. Burn Total: show "0 $GSD burned" with "Coming in Phase 4" note
       - Show "Last updated: X seconds ago" timestamp
       - Use existing Card component with GSD dark theme
       - Handle loading state with skeleton cards

    2. `TransactionList.tsx` -- Transaction history:
       - "use client" directive
       - Props: `initialTransactions?: TreasuryTransaction[]`
       - TanStack Query fetching transactions (same endpoint, extract transactions)
       - Table/list layout:
         - Each row: type icon (green arrow in for inflow, red arrow out for outflow), amount with token type, timestamp (relative), transaction signature (truncated, links to Solana Explorer)
       - Empty state: "No treasury transactions yet"
       - Use Solana Explorer links (explorerUrl helper from transparency-config.ts)
       - Pagination: show 20 most recent, "Load More" button

    3. `(public)/treasury/page.tsx` -- Treasury page:
       - Server Component for SEO
       - `generateMetadata`: title "Treasury Dashboard | GSD Community Hub"
       - Hero: "Treasury" heading, description: "Real-time view of the GSD community treasury. All balances and transactions are verifiable on-chain."
       - Render TreasuryDashboard with server-fetched initial balance (optional, can skip if RPC calls are slow)
       - Render TransactionList
       - Add link to treasury address on Solana Explorer
       - Add link to Squads multisig dashboard (squadsUrl helper from transparency-config.ts)
       - Note section: "Burn tracking will be available when the buy-and-burn mechanism launches in Phase 4"

    All components:
    - GSD dark theme (dark backgrounds, emerald accents)
    - Tailwind CSS matching existing component style
    - Responsive (single column mobile, multi-column desktop)
    - Handle empty/error states gracefully
  </action>
  <verify>Run `cd apps/web && npx tsc --noEmit`. Optionally `pnpm dev --filter=web` and visit http://localhost:3000/treasury to see the page render (balances may be 0 on devnet).</verify>
  <done>Treasury dashboard page renders with balance cards and transaction list. SOL and $GSD balances displayed. Transaction history shows inflows/outflows with Explorer links. Dark theme consistent.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Treasury dashboard with real-time SOL and $GSD balances, transaction history with inflow/outflow categorization, and Explorer links</what-built>
  <how-to-verify>
    1. Run `pnpm dev --filter=web` from project root
    2. Visit http://localhost:3000/treasury
    3. Should see balance cards (SOL and $GSD, likely 0 on devnet)
    4. Should see transaction list (empty if no treasury transactions yet)
    5. Check Explorer link points to correct treasury address on devnet
    6. Verify dark theme and layout are consistent with rest of site
    7. Check burn total shows "Coming in Phase 4" placeholder
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Treasury client fetches SOL balance via RPC
2. Treasury client fetches $GSD token balance via RPC
3. Transaction history fetched via Helius Enhanced Transactions API
4. API endpoint returns combined treasury data with 30-second cache
5. Dashboard displays balances and transactions
6. Explorer links work correctly
7. Burn total placeholder present
8. Page is publicly accessible
</verification>

<success_criteria>
- Treasury dashboard shows SOL and $GSD balances (sourced from on-chain RPC)
- Transaction history shows inflows and outflows with Solana Explorer links
- Burn total shows placeholder with Phase 4 note
- Page loads without authentication
- Data auto-refreshes every 30 seconds
- Human verification confirms display is correct
</success_criteria>

<output>
After completion, create `.planning/phases/03-governance-idea-rounds/03-07-SUMMARY.md`
</output>
