---
phase: 03-governance-idea-rounds
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - programs/gsd-hub/src/instructions/init_governance_config.rs
  - programs/gsd-hub/src/instructions/create_round.rs
  - programs/gsd-hub/src/instructions/submit_idea.rs
  - programs/gsd-hub/src/instructions/transition_round.rs
  - programs/gsd-hub/src/instructions/mod.rs
  - programs/gsd-hub/src/lib.rs
  - programs/gsd-hub/tests/governance-rounds.test.ts
autonomous: true

must_haves:
  truths:
    - "Admin can initialize governance config with token mint and veto authority"
    - "Admin can create a time-bounded idea round with start/end timestamps"
    - "User can submit an idea to an open round"
    - "Anyone can crank round state transitions after deadline passes"
    - "Round transitions are rejected before deadline"
    - "Ideas cannot be submitted after submission period ends"
  artifacts:
    - path: "programs/gsd-hub/src/instructions/init_governance_config.rs"
      provides: "InitGovernanceConfig instruction handler"
      contains: "pub fn handler"
    - path: "programs/gsd-hub/src/instructions/create_round.rs"
      provides: "CreateRound instruction handler"
      contains: "pub fn handler"
    - path: "programs/gsd-hub/src/instructions/submit_idea.rs"
      provides: "SubmitIdea instruction handler"
      contains: "pub fn handler"
    - path: "programs/gsd-hub/src/instructions/transition_round.rs"
      provides: "TransitionRound instruction handler"
      contains: "pub fn handler"
    - path: "programs/gsd-hub/src/lib.rs"
      provides: "4 new instruction entry points"
      contains: "init_governance_config"
    - path: "programs/gsd-hub/tests/governance-rounds.test.ts"
      provides: "Bankrun tests for round lifecycle"
      contains: "describe.*governance"
  key_links:
    - from: "programs/gsd-hub/src/instructions/create_round.rs"
      to: "programs/gsd-hub/src/state/governance_config.rs"
      via: "GovernanceConfig.round_count increment"
      pattern: "governance_config.round_count"
    - from: "programs/gsd-hub/src/instructions/submit_idea.rs"
      to: "programs/gsd-hub/src/state/idea_round.rs"
      via: "RoundStatus::Open check + idea_count increment"
      pattern: "RoundStatus::Open"
    - from: "programs/gsd-hub/src/instructions/transition_round.rs"
      to: "programs/gsd-hub/src/state/idea_round.rs"
      via: "Status transition based on clock timestamps"
      pattern: "round.status.*RoundStatus"
---

<objective>
Implement the idea round lifecycle instructions in the gsd-hub Anchor program: governance config initialization, round creation, idea submission, and permissionless round state transitions. Includes bankrun integration tests.

Purpose: These instructions satisfy IDEA-01 through IDEA-05 (admin creates rounds, users submit ideas, rounds transition through OPEN -> VOTING -> CLOSED). The permissionless crank pattern means no automation service is needed.

Output: 4 new instruction files, updated lib.rs with handlers, bankrun test suite for round lifecycle.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-governance-idea-rounds/03-RESEARCH.md
@.planning/phases/03-governance-idea-rounds/03-01-SUMMARY.md

@programs/gsd-hub/src/lib.rs
@programs/gsd-hub/src/errors.rs
@programs/gsd-hub/src/state/mod.rs
@programs/gsd-hub/src/instructions/mod.rs
@programs/gsd-hub/src/instructions/register.rs
@programs/gsd-hub/tests/gsd-hub.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement init_governance_config, create_round, submit_idea, and transition_round instructions</name>
  <files>
    programs/gsd-hub/src/instructions/init_governance_config.rs
    programs/gsd-hub/src/instructions/create_round.rs
    programs/gsd-hub/src/instructions/submit_idea.rs
    programs/gsd-hub/src/instructions/transition_round.rs
    programs/gsd-hub/src/instructions/mod.rs
    programs/gsd-hub/src/lib.rs
  </files>
  <action>
    1. Create `init_governance_config.rs`:
       - Accounts struct `InitGovernanceConfig`:
         - `governance_config`: init, payer = admin, space = 8 + GovernanceConfig::INIT_SPACE, seeds = [b"governance_config"], bump
         - `admin`: Signer, mut (payer)
         - `governance_token_mint`: Account<Mint> (validate it's a valid SPL token mint)
         - `veto_authority`: UncheckedAccount (Squads multisig vault -- just store the key)
         - `system_program`: Program<System>
       - Handler args: `deposit_timelock: i64, execution_timelock: i64`
       - Set all fields. Default deposit_timelock to 604800 (7 days) if 0 passed. Default execution_timelock to 172800 (48h) if 0 passed.
       - round_count = 0, total_deposited = 0
       - Import `anchor_spl::token::Mint` for mint validation

    2. Create `create_round.rs`:
       - Accounts struct `CreateRound`:
         - `governance_config`: mut, seeds = [b"governance_config"], bump = governance_config.bump, constraint = admin.key() == governance_config.admin @ GovernanceError::UnauthorizedAdmin
         - `idea_round`: init, payer = admin, space = 8 + IdeaRound::INIT_SPACE, seeds = [b"idea_round", &governance_config.round_count.to_le_bytes()], bump
         - `admin`: Signer, mut
         - `system_program`: Program<System>
       - Handler args: `submission_start: i64, submission_end: i64, voting_end: i64, quorum_type: QuorumType, content_hash: [u8; 32]`
       - Validate: submission_start < submission_end < voting_end, all > 0 (GovernanceError::InvalidTimestamps)
       - Set round fields: authority = admin, round_index = governance_config.round_count, status = RoundStatus::Open, idea_count = 0
       - Increment governance_config.round_count

    3. Create `submit_idea.rs`:
       - Accounts struct `SubmitIdea`:
         - `idea_round`: mut, seeds = [b"idea_round", &idea_round.round_index.to_le_bytes()], bump = idea_round.bump, constraint = idea_round.status == RoundStatus::Open @ GovernanceError::RoundNotOpen
         - `idea`: init, payer = author, space = 8 + Idea::INIT_SPACE, seeds = [b"idea", idea_round.key().as_ref(), &idea_round.idea_count.to_le_bytes()], bump
         - `author`: Signer, mut
         - `system_program`: Program<System>
       - Handler args: `content_hash: [u8; 32]`
       - Validate: Clock::get().unix_timestamp >= idea_round.submission_start AND < idea_round.submission_end (GovernanceError::SubmissionPeriodEnded)
       - Set idea fields: author, round = idea_round.key(), idea_index = idea_round.idea_count, status = IdeaStatus::Submitted, content_hash, submitted_at = clock.unix_timestamp, all vote weights = 0, voter_count = 0, execution_eligible_at = 0
       - Increment idea_round.idea_count

    4. Create `transition_round.rs`:
       - Accounts struct `TransitionRound`:
         - `idea_round`: mut, seeds = [b"idea_round", &idea_round.round_index.to_le_bytes()], bump = idea_round.bump
       - No signer constraint -- permissionless crank
       - Handler: Check clock vs deadlines per research Pattern 1:
         - Open + now >= submission_end -> Voting
         - Voting + now >= voting_end -> Closed
         - Closed -> error AlreadyClosed

    5. Update `instructions/mod.rs` -- add the 4 new modules and pub use their account structs:
       ```rust
       pub mod init_governance_config;
       pub mod create_round;
       pub mod submit_idea;
       pub mod transition_round;

       pub use init_governance_config::*;
       pub use create_round::*;
       pub use submit_idea::*;
       pub use transition_round::*;
       ```

    6. Update `lib.rs` -- add 4 new instruction handlers in the `gsd_hub` module:
       ```rust
       pub fn init_governance_config(
           ctx: Context<InitGovernanceConfig>,
           deposit_timelock: i64,
           execution_timelock: i64,
       ) -> Result<()> {
           instructions::init_governance_config::handler(ctx, deposit_timelock, execution_timelock)
       }

       pub fn create_round(
           ctx: Context<CreateRound>,
           submission_start: i64,
           submission_end: i64,
           voting_end: i64,
           quorum_type: QuorumType,
           content_hash: [u8; 32],
       ) -> Result<()> {
           instructions::create_round::handler(ctx, submission_start, submission_end, voting_end, quorum_type, content_hash)
       }

       pub fn submit_idea(
           ctx: Context<SubmitIdea>,
           content_hash: [u8; 32],
       ) -> Result<()> {
           instructions::submit_idea::handler(ctx, content_hash)
       }

       pub fn transition_round(
           ctx: Context<TransitionRound>,
       ) -> Result<()> {
           instructions::transition_round::handler(ctx)
       }
       ```

    For the Mint import in init_governance_config, use: `use anchor_spl::token::Mint;`
    Follow the existing instruction pattern from register.rs (separate Accounts struct + handler function).
  </action>
  <verify>Run `anchor build` from the project root. Must compile successfully and generate updated IDL at `target/idl/gsd_hub.json` with all new instructions.</verify>
  <done>4 instruction files compile, lib.rs exports all handlers, `anchor build` succeeds, IDL includes init_governance_config, create_round, submit_idea, transition_round.</done>
</task>

<task type="auto">
  <name>Task 2: Bankrun tests for idea round lifecycle</name>
  <files>programs/gsd-hub/tests/governance-rounds.test.ts</files>
  <action>
    Create `programs/gsd-hub/tests/governance-rounds.test.ts` following the existing test pattern from `gsd-hub.test.ts`:

    Setup:
    - Use `startAnchor` + `BankrunProvider` + `Program<GsdHub>` pattern (import IDL JSON from `../target/idl/gsd_hub.json`)
    - Create a test admin keypair and airdrop SOL
    - Create a test SPL token mint (using `@solana/spl-token` createMint or bankrun equivalent)
    - Need a veto authority keypair (just a regular keypair for testing)

    Test cases:

    1. "initializes governance config":
       - Call `init_governance_config` with the test mint, veto authority, deposit_timelock=604800, execution_timelock=172800
       - Derive GovernanceConfig PDA and fetch account
       - Assert: admin matches, token_mint matches, veto_authority matches, round_count = 0, total_deposited = 0

    2. "creates an idea round":
       - Call `create_round` with timestamps: submission_start = now, submission_end = now + 3600, voting_end = now + 7200, quorum_type = Small, content_hash = [1;32]
       - Derive IdeaRound PDA with round_index=0 and fetch
       - Assert: authority = admin, round_index = 0, status = Open, timestamps correct, idea_count = 0
       - Assert governance_config.round_count = 1

    3. "submits an idea to open round":
       - Create a second keypair (submitter) and airdrop SOL
       - Call `submit_idea` with content_hash = [2;32]
       - Derive Idea PDA (round key, idea_index=0) and fetch
       - Assert: author = submitter, round = round key, idea_index = 0, status = Submitted, vote weights all 0

    4. "rejects idea submission after deadline":
       - Use bankrun `context.warpToSlot()` or `context.setClock()` to advance time past submission_end
       - Attempt `submit_idea` -- expect error matching SubmissionPeriodEnded

    5. "transitions round from Open to Voting":
       - Warp time past submission_end
       - Call `transition_round` (permissionless -- use any signer)
       - Fetch round -- assert status = Voting

    6. "rejects early transition":
       - Create a new round with future submission_end
       - Call `transition_round` immediately -- expect error matching TooEarly

    7. "transitions round from Voting to Closed":
       - Warp time past voting_end
       - Call `transition_round`
       - Fetch round -- assert status = Closed

    For bankrun time manipulation, use `context.setClock()` to set the unix_timestamp. Example:
    ```typescript
    const currentClock = await context.banksClient.getClock();
    context.setClock(new Clock(
      currentClock.slot,
      currentClock.epochStartTimestamp,
      currentClock.epoch,
      currentClock.leaderScheduleEpoch,
      BigInt(targetTimestamp)
    ));
    ```
    Import `Clock` from `solana-bankrun`.

    For SPL token mint creation in bankrun, use the `@solana/spl-token` createMint function with the bankrun provider's connection, or create a raw instruction.

    Use BN.js for i64/u64 args passed to Anchor methods (per project convention from 02-03).
  </action>
  <verify>Run `anchor test` or `pnpm test --filter=gsd-hub` -- all 7 test cases pass.</verify>
  <done>All bankrun tests pass: governance config init, round creation, idea submission, deadline enforcement, and state transitions (Open -> Voting -> Closed).</done>
</task>

</tasks>

<verification>
1. `anchor build` succeeds with all 4 new instructions
2. Generated IDL at `target/idl/gsd_hub.json` includes init_governance_config, create_round, submit_idea, transition_round
3. All 7 bankrun test cases pass
4. Round state machine transitions work correctly: Open -> Voting -> Closed
5. Deadline enforcement prevents early transitions and late submissions
</verification>

<success_criteria>
- Admin can initialize GovernanceConfig singleton PDA
- Admin can create time-bounded idea rounds with auto-incrementing index
- Users can submit ideas to open rounds (rejected after deadline)
- Permissionless crank transitions rounds based on timestamp checks
- All test cases pass in bankrun
</success_criteria>

<output>
After completion, create `.planning/phases/03-governance-idea-rounds/03-03-SUMMARY.md`
</output>
