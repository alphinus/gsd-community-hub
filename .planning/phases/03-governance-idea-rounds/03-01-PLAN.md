---
phase: 03-governance-idea-rounds
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - programs/gsd-hub/Cargo.toml
  - programs/gsd-hub/src/state/governance_config.rs
  - programs/gsd-hub/src/state/idea_round.rs
  - programs/gsd-hub/src/state/idea.rs
  - programs/gsd-hub/src/state/vote_deposit.rs
  - programs/gsd-hub/src/state/vote_record.rs
  - programs/gsd-hub/src/state/mod.rs
  - programs/gsd-hub/src/errors.rs
autonomous: true

must_haves:
  truths:
    - "All governance account structs compile with correct space calculations"
    - "GovernanceConfig, IdeaRound, Idea, VoteDeposit, VoteRecord are exported from state module"
    - "Governance error variants are available for instruction handlers"
    - "anchor-spl token feature is available for token transfer instructions"
  artifacts:
    - path: "programs/gsd-hub/src/state/governance_config.rs"
      provides: "GovernanceConfig singleton PDA account (133 bytes)"
      contains: "pub struct GovernanceConfig"
    - path: "programs/gsd-hub/src/state/idea_round.rs"
      provides: "IdeaRound PDA with RoundStatus enum and QuorumType enum (107 bytes)"
      contains: "pub struct IdeaRound"
    - path: "programs/gsd-hub/src/state/idea.rs"
      provides: "Idea PDA with IdeaStatus enum and vote tally fields (154 bytes)"
      contains: "pub struct Idea"
    - path: "programs/gsd-hub/src/state/vote_deposit.rs"
      provides: "VoteDeposit PDA for token escrow tracking (69 bytes)"
      contains: "pub struct VoteDeposit"
    - path: "programs/gsd-hub/src/state/vote_record.rs"
      provides: "VoteRecord PDA with VoteChoice enum (122 bytes)"
      contains: "pub struct VoteRecord"
    - path: "programs/gsd-hub/src/errors.rs"
      provides: "GovernanceError enum with all governance-specific error codes"
      contains: "GovernanceError"
    - path: "programs/gsd-hub/Cargo.toml"
      provides: "anchor-spl dependency with token feature"
      contains: "anchor-spl"
  key_links:
    - from: "programs/gsd-hub/src/state/mod.rs"
      to: "all governance state files"
      via: "pub mod + pub use re-exports"
      pattern: "pub use governance_config"
    - from: "programs/gsd-hub/src/state/idea_round.rs"
      to: "programs/gsd-hub/src/state/idea.rs"
      via: "QuorumType shared enum"
      pattern: "QuorumType"
---

<objective>
Create all on-chain governance account structs, enums, and error codes for the gsd-hub Anchor program, plus add the anchor-spl dependency for token operations.

Purpose: These state definitions are the foundation that all governance instructions depend on. Nothing else in Phase 3 can be built without the account layouts, enum types, and error codes being defined and compiling.

Output: 5 new state files, extended errors.rs, updated Cargo.toml with anchor-spl. Program compiles with `anchor build`.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-governance-idea-rounds/03-RESEARCH.md

@programs/gsd-hub/Cargo.toml
@programs/gsd-hub/src/lib.rs
@programs/gsd-hub/src/errors.rs
@programs/gsd-hub/src/state/mod.rs
@programs/gsd-hub/src/state/developer.rs
@programs/gsd-hub/src/state/contribution.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anchor-spl dependency and create all governance state accounts</name>
  <files>
    programs/gsd-hub/Cargo.toml
    programs/gsd-hub/src/state/governance_config.rs
    programs/gsd-hub/src/state/idea_round.rs
    programs/gsd-hub/src/state/idea.rs
    programs/gsd-hub/src/state/vote_deposit.rs
    programs/gsd-hub/src/state/vote_record.rs
    programs/gsd-hub/src/state/mod.rs
  </files>
  <action>
    1. Update `programs/gsd-hub/Cargo.toml` to add anchor-spl with token feature:
       ```toml
       anchor-spl = { version = "0.32.1", features = ["token"] }
       ```

    2. Create `governance_config.rs` -- GovernanceConfig singleton PDA account:
       - Fields: admin (Pubkey), veto_authority (Pubkey), governance_token_mint (Pubkey), bump (u8), round_count (u32), total_deposited (u64), deposit_timelock (i64, default 7 days = 604800), execution_timelock (i64, default 48 hours = 172800)
       - PDA seeds: `["governance_config"]`
       - Use `#[account]` and `#[derive(InitSpace)]`
       - Total: 8 (disc) + 32 + 32 + 32 + 1 + 4 + 8 + 8 + 8 = 133 bytes
       - Add `impl QuorumType` with `pub fn required_bps(&self) -> u64` returning 500/2000/3300

    3. Create `idea_round.rs` -- IdeaRound PDA account:
       - Define `RoundStatus` enum: Open, Voting, Closed (unit variants, AnchorSerialize + AnchorDeserialize + Clone + Copy + PartialEq + Eq + InitSpace)
       - Define `QuorumType` enum: Small, Treasury, ParameterChange (same derives)
       - Fields: authority (Pubkey), round_index (u32), bump (u8), status (RoundStatus), submission_start (i64), submission_end (i64), voting_end (i64), idea_count (u32), quorum_type (QuorumType), content_hash ([u8; 32])
       - PDA seeds: `["idea_round", round_index.to_le_bytes()]`
       - Total: 8 + 32 + 4 + 1 + 1 + 8 + 8 + 8 + 4 + 1 + 32 = 107 bytes

    4. Create `idea.rs` -- Idea submission PDA:
       - Define `IdeaStatus` enum: Submitted, Approved, Rejected, Vetoed
       - Fields: author (Pubkey), round (Pubkey), idea_index (u32), bump (u8), status (IdeaStatus), content_hash ([u8; 32]), submitted_at (i64), yes_weight (u64), no_weight (u64), abstain_weight (u64), voter_count (u32), execution_eligible_at (i64)
       - PDA seeds: `["idea", round.key(), idea_index.to_le_bytes()]`
       - Total: 8 + 32 + 32 + 4 + 1 + 1 + 32 + 8 + 8 + 8 + 8 + 4 + 8 = 154 bytes

    5. Create `vote_deposit.rs` -- VoteDeposit PDA for token escrow:
       - Fields: authority (Pubkey), bump (u8), deposited_amount (u64), deposit_timestamp (i64), eligible_at (i64), active_votes (u32)
       - PDA seeds: `["vote_deposit", authority.key()]`
       - Total: 8 + 32 + 1 + 8 + 8 + 8 + 4 = 69 bytes

    6. Create `vote_record.rs` -- VoteRecord PDA:
       - Define `VoteChoice` enum: Yes, No, Abstain
       - Fields: voter (Pubkey), idea (Pubkey), round (Pubkey), bump (u8), vote (VoteChoice), weight (u64), voted_at (i64)
       - PDA seeds: `["vote_record", voter.key(), idea.key()]`
       - Total: 8 + 32 + 32 + 32 + 1 + 1 + 8 + 8 = 122 bytes

    7. Update `state/mod.rs` to add all new modules:
       ```rust
       pub mod governance_config;
       pub mod idea_round;
       pub mod idea;
       pub mod vote_deposit;
       pub mod vote_record;

       pub use governance_config::*;
       pub use idea_round::*;
       pub use idea::*;
       pub use vote_deposit::*;
       pub use vote_record::*;
       ```
       Keep existing developer, contribution, merkle_tree modules.

    Follow the existing pattern from developer.rs and contribution.rs for struct layout and derives.
  </action>
  <verify>Run `cd programs/gsd-hub && cargo check` -- all state structs must compile without errors.</verify>
  <done>All 5 governance state files exist, are exported from mod.rs, and cargo check passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extend errors.rs with governance error codes</name>
  <files>programs/gsd-hub/src/errors.rs</files>
  <action>
    Add a new `GovernanceError` error enum (separate from existing `GsdHubError`) to `errors.rs`:

    ```rust
    #[error_code]
    pub enum GovernanceError {
        #[msg("Round is not in Open state")]
        RoundNotOpen,

        #[msg("Round is not in Voting state")]
        RoundNotInVotingState,

        #[msg("Round is already closed")]
        AlreadyClosed,

        #[msg("Transition too early -- deadline not reached")]
        TooEarly,

        #[msg("Submission period has ended")]
        SubmissionPeriodEnded,

        #[msg("Voting period has ended")]
        VotingPeriodEnded,

        #[msg("No tokens deposited")]
        NoDeposit,

        #[msg("Tokens not yet eligible for voting (7-day timelock)")]
        TokensNotYetEligible,

        #[msg("Cannot withdraw while votes are active")]
        ActiveVotesExist,

        #[msg("Arithmetic overflow")]
        Overflow,

        #[msg("Unauthorized -- not the admin")]
        UnauthorizedAdmin,

        #[msg("Unauthorized veto -- not the veto authority")]
        UnauthorizedVeto,

        #[msg("Invalid timestamps -- end must be after start")]
        InvalidTimestamps,

        #[msg("Idea is not in a vetoable state")]
        NotVetoable,

        #[msg("Round still active -- cannot relinquish vote")]
        RoundStillActive,

        #[msg("Insufficient deposit amount")]
        InsufficientDeposit,
    }
    ```

    Keep the existing `GsdHubError` enum intact. Anchor supports multiple error enums in the same file.
  </action>
  <verify>Run `cd programs/gsd-hub && cargo check` -- errors compile and are usable by future instruction handlers.</verify>
  <done>GovernanceError enum exists in errors.rs with all governance-specific error codes. Existing GsdHubError unchanged. Program compiles.</done>
</task>

</tasks>

<verification>
1. `cd "programs/gsd-hub" && cargo check` passes with no errors
2. All 5 new state files exist in `programs/gsd-hub/src/state/`
3. `state/mod.rs` exports all new types
4. `errors.rs` contains both `GsdHubError` and `GovernanceError`
5. `Cargo.toml` includes `anchor-spl` with `token` feature
</verification>

<success_criteria>
- Program compiles with `cargo check` (no errors)
- GovernanceConfig, IdeaRound, Idea, VoteDeposit, VoteRecord structs all defined with correct fields and InitSpace derives
- RoundStatus, QuorumType, IdeaStatus, VoteChoice enums defined with unit variants
- GovernanceError enum has all 16 error codes
- anchor-spl available as dependency for token CPI in later plans
</success_criteria>

<output>
After completion, create `.planning/phases/03-governance-idea-rounds/03-01-SUMMARY.md`
</output>
