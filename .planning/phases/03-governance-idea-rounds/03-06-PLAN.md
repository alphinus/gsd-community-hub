---
phase: 03-governance-idea-rounds
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - apps/web/app/(public)/governance/page.tsx
  - apps/web/app/(public)/governance/rounds/page.tsx
  - apps/web/app/(public)/governance/rounds/[id]/page.tsx
  - apps/web/app/(auth)/governance/page.tsx
  - apps/web/app/(auth)/governance/deposit/page.tsx
  - apps/web/components/governance/RoundCard.tsx
  - apps/web/components/governance/IdeaList.tsx
  - apps/web/components/governance/IdeaForm.tsx
  - apps/web/components/governance/VotePanel.tsx
  - apps/web/components/governance/DepositPanel.tsx
  - apps/web/components/governance/VotingPowerDisplay.tsx
  - apps/web/components/governance/RoundStatusBadge.tsx
autonomous: false

must_haves:
  truths:
    - "User can view all idea rounds with status and idea counts"
    - "User can view ideas within a round sorted by submission time"
    - "User can submit an idea to an open round via UI form"
    - "User can see voting results (Yes/No/Abstain tallies) for each idea"
    - "User can deposit $GSD tokens and see their voting power"
    - "User can vote Yes/No/Abstain on ideas during voting period"
    - "User can view their voting power and active positions"
  artifacts:
    - path: "apps/web/app/(public)/governance/rounds/page.tsx"
      provides: "Public round listing page"
      min_lines: 30
    - path: "apps/web/app/(public)/governance/rounds/[id]/page.tsx"
      provides: "Round detail page with ideas and vote tallies"
      min_lines: 50
    - path: "apps/web/app/(auth)/governance/deposit/page.tsx"
      provides: "Token deposit/withdrawal page"
      min_lines: 40
    - path: "apps/web/components/governance/VotePanel.tsx"
      provides: "Yes/No/Abstain voting buttons with weight display"
      min_lines: 30
    - path: "apps/web/components/governance/DepositPanel.tsx"
      provides: "Token deposit form with balance and timelock display"
      min_lines: 40
    - path: "apps/web/components/governance/IdeaForm.tsx"
      provides: "Idea submission form for open rounds"
      min_lines: 30
  key_links:
    - from: "apps/web/app/(public)/governance/rounds/page.tsx"
      to: "/api/governance/rounds"
      via: "fetch or TanStack Query"
      pattern: "api/governance/rounds"
    - from: "apps/web/app/(public)/governance/rounds/[id]/page.tsx"
      to: "/api/governance/rounds/[id]/ideas"
      via: "fetch for ideas within round"
      pattern: "api/governance/rounds.*ideas"
    - from: "apps/web/components/governance/VotePanel.tsx"
      to: "gsd-hub program"
      via: "Anchor cast_vote instruction"
      pattern: "castVote|cast_vote"
    - from: "apps/web/components/governance/DepositPanel.tsx"
      to: "gsd-hub program"
      via: "Anchor deposit_tokens instruction"
      pattern: "depositTokens|deposit_tokens"
---

<objective>
Build the governance UI: public round listing, round detail with ideas, idea submission form, voting panel, and token deposit/withdrawal interface.

Purpose: This satisfies the user-facing requirements: IDEA-02 (submit ideas), IDEA-03 (view ideas), IDEA-06 (view round history), GOVR-02 (deposit for voting weight), GOVR-03 (vote Yes/No/Abstain), GOVR-09 (view voting history), GOVR-10 (view voting power). The UI ties together the on-chain program and API endpoints into a usable experience.

Output: 4 page routes (2 public, 2 authenticated), 7 governance components.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-governance-idea-rounds/03-RESEARCH.md
@.planning/phases/03-governance-idea-rounds/03-05-SUMMARY.md

@apps/web/app/(public)/transparency/page.tsx
@apps/web/app/(auth)/profile/page.tsx
@apps/web/components/contributions/ContributionCard.tsx
@apps/web/components/contributions/ContributionList.tsx
@apps/web/lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create governance components (RoundCard, IdeaList, IdeaForm, VotePanel, DepositPanel, VotingPowerDisplay, RoundStatusBadge)</name>
  <files>
    apps/web/components/governance/RoundCard.tsx
    apps/web/components/governance/IdeaList.tsx
    apps/web/components/governance/IdeaForm.tsx
    apps/web/components/governance/VotePanel.tsx
    apps/web/components/governance/DepositPanel.tsx
    apps/web/components/governance/VotingPowerDisplay.tsx
    apps/web/components/governance/RoundStatusBadge.tsx
  </files>
  <action>
    Follow the existing component patterns from contributions (ContributionCard, ContributionList) and UI components (Card, Badge, Button).

    1. `RoundStatusBadge.tsx`:
       - Props: `status: RoundStatus, submissionEnd: Date, votingEnd: Date`
       - Display badge with color: Open = emerald, Voting = amber, Closed = gray
       - Include effective status check: if status is "open" but now > submissionEnd, show "Transitioning to Voting..."
       - Same for voting -> closed stale status (Research Pitfall 4)
       - Use existing Badge component

    2. `RoundCard.tsx`:
       - Props: `round: IdeaRound` (from @gsd/types)
       - Card layout: title, status badge, quorum type label, dates (submission start/end, voting end), idea count
       - Format dates as relative ("2 days left", "Ended 3 hours ago")
       - Link to `/governance/rounds/{id}` detail page
       - Use existing Card component
       - "use client" directive

    3. `IdeaList.tsx`:
       - Props: `roundId: string, roundStatus: RoundStatus`
       - Client component with TanStack Query fetching from `/api/governance/rounds/{roundId}/ideas`
       - Each idea shows: title, author (truncated wallet), status, vote tallies (bar chart showing Yes/No/Abstain proportions)
       - Sort controls: newest, most_votes
       - Pagination with load more
       - Loading skeletons (follow ContributionList pattern)

    4. `IdeaForm.tsx`:
       - Props: `roundId: string, roundOnChainAddress: string, ideaCount: number`
       - "use client" directive
       - Form fields: title (max 200 chars), description (textarea, max 5000 chars)
       - On submit:
         a. Compute content_hash = SHA-256 of canonical JSON { title, description }
         b. Send on-chain `submit_idea` transaction via Anchor program (using useGsdProgram hook)
         c. On tx confirmation, POST to `/api/governance/rounds/{roundId}/ideas` with off-chain data + tx signature + on-chain address
         d. Show success toast (sonner) and reset form
       - Use existing Input, Label, Textarea components
       - Requires wallet connected (use useWallet hook, show connect prompt if not)
       - Import computeProfileHash pattern from existing code, adapt for idea content

    5. `VotePanel.tsx`:
       - Props: `idea: Idea, roundStatus: RoundStatus, userDeposit: VoteDepositInfo | null`
       - Show current tallies: Yes/No/Abstain with weight and percentage bar
       - If roundStatus === "voting" AND userDeposit?.isEligible:
         - Show 3 voting buttons (Yes, No, Abstain) with voting weight display
         - On click: send on-chain `cast_vote` transaction via Anchor
         - After vote: refetch idea data, disable buttons
       - If already voted (fetch user's VoteRecord): show "You voted: {choice}" with weight
       - If not eligible: show "Deposit tokens and wait 7 days to vote"
       - Use emerald for Yes, red for No, gray for Abstain

    6. `DepositPanel.tsx`:
       - "use client" directive
       - Shows current deposit amount, eligible date, active votes count
       - Deposit form: amount input + "Deposit" button
         - On submit: send on-chain `deposit_tokens` via Anchor
         - Requires user's $GSD token balance (fetch via @solana/spl-token getAccount)
       - Withdraw section (if active_votes === 0):
         - Amount input + "Withdraw" button
         - On submit: send on-chain `withdraw_tokens` via Anchor
       - Show timelock countdown if not yet eligible
       - Use existing Input, Button components

    7. `VotingPowerDisplay.tsx`:
       - Props: `wallet: string`
       - Fetches deposit info from `/api/governance/deposit?wallet={wallet}`
       - Shows: deposited amount, eligible status, active votes
       - Compact display for sidebar/header use
       - If no deposit: show "No tokens deposited" with link to deposit page

    All components:
    - Follow GSD dark theme (emerald accent, dark backgrounds)
    - Use Tailwind CSS classes matching existing component style
    - Handle loading states with skeletons
    - Handle error states gracefully
    - "use client" for interactive components
  </action>
  <verify>Run `cd apps/web && npx tsc --noEmit` to verify all components compile. Check for no import errors.</verify>
  <done>7 governance components created, all compile, follow existing design patterns and GSD dark theme.</done>
</task>

<task type="auto">
  <name>Task 2: Create governance pages (public rounds, round detail, auth dashboard, deposit page)</name>
  <files>
    apps/web/app/(public)/governance/page.tsx
    apps/web/app/(public)/governance/rounds/page.tsx
    apps/web/app/(public)/governance/rounds/[id]/page.tsx
    apps/web/app/(auth)/governance/page.tsx
    apps/web/app/(auth)/governance/deposit/page.tsx
  </files>
  <action>
    1. `(public)/governance/page.tsx` -- Public governance overview:
       - Server Component
       - Hero section: "Governance" heading, brief description of how idea rounds work
       - Stats: total rounds, active rounds count, total deposited tokens (Prisma aggregates)
       - Link to "/governance/rounds" for full round listing
       - Link to authenticated governance dashboard for depositing/voting

    2. `(public)/governance/rounds/page.tsx` -- Public round listing:
       - Server Component with initial data from Prisma
       - Query: `ideaRound.findMany` ordered by createdAt desc, with idea count
       - Render RoundCard grid (same pattern as explore/directory page)
       - Group by status: Active (open/voting) first, then Closed
       - Pagination via client component wrapper if needed

    3. `(public)/governance/rounds/[id]/page.tsx` -- Round detail:
       - Server Component for initial data + SEO metadata
       - Fetch round by ID from Prisma with ideas included
       - Display: round title, description, status badge, quorum type, dates
       - Render IdeaList component (client component for pagination/sorting)
       - If round is Open: show IdeaForm (authenticated users only)
       - If round is Voting: show VotePanel per idea
       - Show effective status based on timestamps (handle stale on-chain status)
       - SEO: generateMetadata for round title

    4. `(auth)/governance/page.tsx` -- Authenticated governance dashboard:
       - Server Component
       - Shows: VotingPowerDisplay for current user
       - Quick links: "Deposit Tokens", "View Rounds", "My Votes"
       - Recent activity: user's recent votes (Prisma query by wallet)
       - Requires auth session (redirect to login if not authenticated)

    5. `(auth)/governance/deposit/page.tsx` -- Token deposit page:
       - Client Component (needs wallet interaction)
       - Render DepositPanel component
       - Show deposit history / timeline
       - Explain the 7-day timelock and how voting weight works
       - Link back to governance dashboard

    All pages:
    - Follow existing page patterns (Server Components for SEO, client wrappers for interactivity)
    - Use the GSD dark theme layout
    - Add appropriate SEO metadata (generateMetadata for server components)
    - Handle empty states ("No rounds yet", "No ideas submitted")
  </action>
  <verify>Run `cd apps/web && npx tsc --noEmit` to verify all pages compile. Optionally `pnpm dev --filter=web` to check pages render without runtime errors.</verify>
  <done>5 governance pages created. Public round listing and detail pages render with server-side data. Authenticated dashboard and deposit page support wallet interaction. All compile.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete governance UI: round listing, round detail with ideas, idea submission form, voting panel with Yes/No/Abstain, token deposit/withdrawal, and voting power display</what-built>
  <how-to-verify>
    1. Run `pnpm dev --filter=web` from project root
    2. Visit http://localhost:3000/governance -- should see governance overview page
    3. Visit http://localhost:3000/governance/rounds -- should see round listing (empty state if no rounds exist)
    4. Connect wallet and visit http://localhost:3000/governance (auth) -- should see governance dashboard with voting power display
    5. Visit http://localhost:3000/governance/deposit -- should see deposit panel (will need $GSD tokens to actually deposit)
    6. Verify the dark theme and emerald accent colors are consistent with the rest of the site
    7. Check that empty states display correctly (no rounds, no ideas, no deposit)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All 7 governance components compile and follow existing design patterns
2. All 5 page routes render correctly in dev mode
3. Public pages are accessible without authentication
4. Authenticated pages require wallet connection
5. Round detail page shows ideas with vote tallies
6. Idea form submits on-chain transaction + off-chain content
7. Vote panel sends cast_vote transaction
8. Deposit panel handles deposit/withdraw via Anchor
9. Effective status display handles stale on-chain status
</verification>

<success_criteria>
- User can browse rounds and ideas without authentication
- Authenticated user can submit ideas to open rounds
- Authenticated user can deposit tokens and view voting power
- Authenticated user can vote on ideas during voting period
- All pages follow GSD dark theme
- Empty states handled gracefully
- Human verification confirms UI is functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-governance-idea-rounds/03-06-SUMMARY.md`
</output>
