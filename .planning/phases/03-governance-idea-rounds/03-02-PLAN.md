---
phase: 03-governance-idea-rounds
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/types/src/governance.ts
  - packages/types/src/treasury.ts
  - packages/types/src/index.ts
  - packages/utils/src/governance-pda.ts
  - packages/utils/src/index.ts
  - apps/web/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "TypeScript governance types match on-chain Rust enum and struct shapes"
    - "PDA derivation functions produce addresses matching on-chain seeds"
    - "Prisma models for IdeaRound, Idea, Vote, VoteDeposit exist and can be pushed to database"
    - "Treasury types are defined for dashboard data"
  artifacts:
    - path: "packages/types/src/governance.ts"
      provides: "TypeScript types: RoundStatus, QuorumType, IdeaStatus, VoteChoice, IdeaRound, Idea, VoteRecord, VoteDeposit, GovernanceConfig"
      exports: ["RoundStatus", "QuorumType", "IdeaRound", "Idea", "VoteRecord", "VoteDeposit"]
    - path: "packages/types/src/treasury.ts"
      provides: "TypeScript types: TreasuryBalance, TreasuryTransaction"
      exports: ["TreasuryBalance", "TreasuryTransaction"]
    - path: "packages/utils/src/governance-pda.ts"
      provides: "PDA derivation for all governance accounts"
      exports: ["getGovernanceConfigPDA", "getIdeaRoundPDA", "getIdeaPDA", "getVoteDepositPDA", "getVoteRecordPDA"]
    - path: "apps/web/prisma/schema.prisma"
      provides: "IdeaRound, Idea, Vote, VoteDeposit Prisma models"
      contains: "model IdeaRound"
  key_links:
    - from: "packages/types/src/governance.ts"
      to: "packages/types/src/index.ts"
      via: "barrel export"
      pattern: "export.*from.*governance"
    - from: "packages/utils/src/governance-pda.ts"
      to: "packages/utils/src/index.ts"
      via: "barrel export"
      pattern: "export.*from.*governance-pda"
---

<objective>
Create shared TypeScript governance types, PDA derivation helpers, and Prisma database models for the off-chain governance layer.

Purpose: The TypeScript types mirror the on-chain state structs, PDA helpers enable client-side account derivation, and Prisma models store indexed governance data. All three are consumed by API endpoints and UI components in later plans.

Output: @gsd/types governance exports, @gsd/utils PDA functions, extended Prisma schema ready for `prisma db push`.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-governance-idea-rounds/03-RESEARCH.md

@packages/types/src/index.ts
@packages/types/src/contribution.ts
@packages/types/src/profile.ts
@packages/utils/src/index.ts
@packages/utils/src/pda.ts
@apps/web/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create governance and treasury TypeScript types + PDA derivation helpers</name>
  <files>
    packages/types/src/governance.ts
    packages/types/src/treasury.ts
    packages/types/src/index.ts
    packages/utils/src/governance-pda.ts
    packages/utils/src/index.ts
  </files>
  <action>
    1. Create `packages/types/src/governance.ts` with these types (matching on-chain enums/structs):
       - `RoundStatus`: "open" | "voting" | "closed"
       - `QuorumType`: "small" | "treasury" | "parameter_change"
       - `IdeaStatus`: "submitted" | "approved" | "rejected" | "vetoed"
       - `VoteChoice`: "yes" | "no" | "abstain"
       - `IdeaRound` interface: { id, roundIndex, onChainAddress, title, description, contentHash, status: RoundStatus, submissionStart: Date, submissionEnd: Date, votingEnd: Date, ideaCount, quorumType: QuorumType, createdAt: Date }
       - `Idea` interface: { id, ideaIndex, onChainAddress, roundId, authorWallet, title, description, contentHash, status: IdeaStatus, yesWeight: string, noWeight: string, abstainWeight: string, voterCount, submittedAt: Date }
         (BigInt weights serialized as strings per project convention from 02-05)
       - `VoteRecord` interface: { id, onChainAddress, ideaId, voterWallet, vote: VoteChoice, weight: string, votedAt: Date }
       - `VoteDepositInfo` interface: { walletAddress, depositedAmount: string, depositTimestamp: Date, eligibleAt: Date, activeVotes: number, isEligible: boolean }
       - `GovernanceConfig` interface: { admin: string, vetoAuthority: string, tokenMint: string, roundCount: number, totalDeposited: string, depositTimelock: number, executionTimelock: number }
       - `CreateIdeaInput`: { roundId: string, title: string, description: string }
       - `CreateRoundInput`: { title: string, description: string, submissionStart: Date, submissionEnd: Date, votingEnd: Date, quorumType: QuorumType }

    2. Create `packages/types/src/treasury.ts`:
       - `TreasuryBalance`: { solBalance: number, gsdBalance: string, lastUpdated: Date }
       - `TreasuryTransaction`: { signature: string, type: "inflow" | "outflow", amount: number, token: "SOL" | "GSD", timestamp: Date, description?: string }

    3. Update `packages/types/src/index.ts` to add barrel exports:
       ```typescript
       export * from "./governance"
       export * from "./treasury"
       ```
       Keep existing exports for contribution and profile.

    4. Create `packages/utils/src/governance-pda.ts` with PDA derivation functions:
       - `GOVERNANCE_CONFIG_SEED = "governance_config"`
       - `IDEA_ROUND_SEED = "idea_round"`
       - `IDEA_SEED = "idea"`
       - `VOTE_DEPOSIT_SEED = "vote_deposit"`
       - `VOTE_RECORD_SEED = "vote_record"`
       - `getGovernanceConfigPDA(programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from("governance_config")]
       - `getIdeaRoundPDA(roundIndex: number, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from("idea_round"), u32LE(roundIndex)]
       - `getIdeaPDA(round: PublicKey, ideaIndex: number, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from("idea"), round.toBuffer(), u32LE(ideaIndex)]
       - `getVoteDepositPDA(wallet: PublicKey, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from("vote_deposit"), wallet.toBuffer()]
       - `getVoteRecordPDA(voter: PublicKey, idea: PublicKey, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from("vote_record"), voter.toBuffer(), idea.toBuffer()]
       - Use `PublicKey.findProgramAddressSync` from `@solana/web3.js`
       - For u32LE encoding: `const buf = Buffer.alloc(4); buf.writeUInt32LE(value); return buf;`
       - Do NOT add .js extension to imports (per 02-05 Turbopack decision)

    5. Update `packages/utils/src/index.ts` to add:
       ```typescript
       export * from "./governance-pda"
       ```
       Keep existing exports for pda, hash, score, contribution-hash.
  </action>
  <verify>
    Run `cd packages/types && npx tsc --noEmit` and `cd packages/utils && npx tsc --noEmit` to verify TypeScript compilation. If no tsconfig exists for standalone check, verify via `pnpm turbo build --filter=@gsd/types --filter=@gsd/utils` or import from apps/web.
  </verify>
  <done>All governance types exported from @gsd/types, all PDA functions exported from @gsd/utils, TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Prisma schema with governance models</name>
  <files>apps/web/prisma/schema.prisma</files>
  <action>
    Add 4 new models to the existing Prisma schema (after existing Contribution and ProgramUpgrade models):

    1. `IdeaRound` model:
       ```prisma
       model IdeaRound {
         id              String   @id @default(cuid())
         roundIndex      Int      @unique
         onChainAddress  String   @unique
         title           String   @db.VarChar(200)
         description     String   @db.Text
         contentHash     String
         status          String   @default("open")
         submissionStart DateTime
         submissionEnd   DateTime
         votingEnd       DateTime
         ideaCount       Int      @default(0)
         quorumType      String
         createdAt       DateTime @default(now())
         updatedAt       DateTime @updatedAt

         ideas           Idea[]

         @@index([status])
         @@index([submissionEnd])
         @@index([votingEnd])
       }
       ```

    2. `Idea` model:
       ```prisma
       model Idea {
         id                   String   @id @default(cuid())
         ideaIndex            Int
         onChainAddress       String   @unique
         roundId              String
         authorWallet         String
         title                String   @db.VarChar(200)
         description          String   @db.Text
         contentHash          String
         status               String   @default("submitted")
         yesWeight            BigInt   @default(0)
         noWeight             BigInt   @default(0)
         abstainWeight        BigInt   @default(0)
         voterCount           Int      @default(0)
         transactionSignature String   @unique
         submittedAt          DateTime @default(now())

         round                IdeaRound @relation(fields: [roundId], references: [id])
         votes                Vote[]

         @@index([roundId])
         @@index([authorWallet])
       }
       ```

    3. `Vote` model:
       ```prisma
       model Vote {
         id                   String   @id @default(cuid())
         onChainAddress       String   @unique
         ideaId               String
         voterWallet          String
         vote                 String
         weight               BigInt
         transactionSignature String   @unique
         votedAt              DateTime

         idea                 Idea @relation(fields: [ideaId], references: [id])

         @@unique([ideaId, voterWallet])
         @@index([voterWallet])
       }
       ```

    4. `VoteDeposit` model:
       ```prisma
       model VoteDeposit {
         id              String   @id @default(cuid())
         walletAddress   String   @unique
         depositedAmount BigInt
         depositTimestamp DateTime
         eligibleAt      DateTime
         activeVotes     Int      @default(0)
         updatedAt       DateTime @updatedAt

         @@index([walletAddress])
       }
       ```

    Keep all existing models (User, Contribution, ProgramUpgrade) unchanged.

    After adding models, run `npx prisma generate` to regenerate the client (do NOT run `prisma db push` -- that's user setup).
  </action>
  <verify>Run `cd apps/web && npx prisma validate` to confirm schema is valid. Then `npx prisma generate` to verify client generation succeeds.</verify>
  <done>Prisma schema contains IdeaRound, Idea, Vote, VoteDeposit models with correct relations and indexes. `prisma validate` passes. `prisma generate` succeeds.</done>
</task>

</tasks>

<verification>
1. `packages/types/src/governance.ts` exports all governance types
2. `packages/types/src/treasury.ts` exports treasury types
3. `packages/utils/src/governance-pda.ts` exports 5 PDA derivation functions
4. Barrel exports in both packages include new modules
5. `npx prisma validate` passes in apps/web/
6. TypeScript types use string serialization for BigInt fields (project convention)
</verification>

<success_criteria>
- @gsd/types exports RoundStatus, QuorumType, IdeaStatus, VoteChoice, IdeaRound, Idea, VoteRecord, VoteDepositInfo, GovernanceConfig, TreasuryBalance, TreasuryTransaction
- @gsd/utils exports getGovernanceConfigPDA, getIdeaRoundPDA, getIdeaPDA, getVoteDepositPDA, getVoteRecordPDA
- Prisma schema validates with 4 new models (IdeaRound, Idea, Vote, VoteDeposit)
- No .js extensions in barrel exports (Turbopack compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/03-governance-idea-rounds/03-02-SUMMARY.md`
</output>
