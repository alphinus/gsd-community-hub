---
phase: 04-revenue-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - programs/gsd-hub/src/state/revenue_config.rs
  - programs/gsd-hub/src/state/revenue_event.rs
  - programs/gsd-hub/src/state/revenue_claim.rs
  - programs/gsd-hub/src/state/revenue_vault.rs
  - programs/gsd-hub/src/state/mod.rs
  - programs/gsd-hub/src/errors.rs
  - packages/types/src/revenue.ts
  - packages/types/src/index.ts
  - packages/utils/src/revenue-pda.ts
  - packages/utils/src/index.ts
  - apps/web/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "RevenueConfig, RevenueEvent, and RevenueClaim account structs compile and derive InitSpace"
    - "RevenueError enum has error codes for all revenue failure cases"
    - "TypeScript revenue types mirror Rust enums with lowercase string unions"
    - "PDA derivation functions produce deterministic addresses from seeds"
    - "Prisma schema has RevenueEvent, RevenueClaim, and PendingRevenue models with correct relations"
  artifacts:
    - path: "programs/gsd-hub/src/state/revenue_config.rs"
      provides: "RevenueConfig singleton PDA struct"
      contains: "pub struct RevenueConfig"
    - path: "programs/gsd-hub/src/state/revenue_event.rs"
      provides: "RevenueEvent PDA struct with split amounts and burn traceability"
      contains: "pub struct RevenueEvent"
    - path: "programs/gsd-hub/src/state/revenue_claim.rs"
      provides: "RevenueClaim PDA for per-contributor per-event claims"
      contains: "pub struct RevenueClaim"
    - path: "packages/types/src/revenue.ts"
      provides: "TypeScript revenue domain types"
      exports: ["RevenueStatus", "RevenueToken", "RevenueEventInfo", "RevenueClaimInfo", "RevenueConfigInfo"]
    - path: "packages/utils/src/revenue-pda.ts"
      provides: "Revenue PDA derivation functions"
      exports: ["getRevenueConfigPDA", "getRevenueEventPDA", "getRevenueClaimPDA", "getRevenueVaultPDA"]
    - path: "apps/web/prisma/schema.prisma"
      provides: "RevenueEvent, RevenueClaim, and PendingRevenue Prisma models"
      contains: "model PendingRevenue"
  key_links:
    - from: "packages/types/src/revenue.ts"
      to: "programs/gsd-hub/src/state/revenue_event.rs"
      via: "TypeScript types mirror Rust enums"
      pattern: "RevenueStatus.*recorded.*distributing.*completed"
    - from: "packages/utils/src/revenue-pda.ts"
      to: "programs/gsd-hub/src/state/revenue_config.rs"
      via: "PDA seeds match"
      pattern: "revenue_config"
---

<objective>
Create revenue state account structs, error codes, TypeScript types, PDA helpers, and Prisma schema for the revenue distribution system.

Purpose: Establish the data foundation for all revenue mechanics -- on-chain state, off-chain persistence, and shared types that instructions, indexer, and UI will consume.
Output: 3 Rust state structs, 1 error enum, TypeScript types/PDA package, Prisma models
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-revenue-mechanics/04-RESEARCH.md

# Prior art for state struct patterns
@programs/gsd-hub/src/state/governance_config.rs
@programs/gsd-hub/src/state/vote_deposit.rs
@programs/gsd-hub/src/state/vote_record.rs
@programs/gsd-hub/src/errors.rs

# Prior art for TypeScript types and PDA helpers
@packages/types/src/governance.ts
@packages/utils/src/governance-pda.ts
@packages/types/src/index.ts
@packages/utils/src/index.ts

# Prisma schema to extend
@apps/web/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue state account structs and error codes</name>
  <files>
    programs/gsd-hub/src/state/revenue_config.rs
    programs/gsd-hub/src/state/revenue_event.rs
    programs/gsd-hub/src/state/revenue_claim.rs
    programs/gsd-hub/src/state/revenue_vault.rs
    programs/gsd-hub/src/state/mod.rs
    programs/gsd-hub/src/errors.rs
  </files>
  <action>
Create three new Rust state files in `programs/gsd-hub/src/state/`:

**revenue_config.rs** -- RevenueConfig singleton PDA (seeds: ["revenue_config"]):
- `admin: Pubkey` (32 bytes) -- authority who can update config
- `bump: u8` (1 byte)
- `developer_bps: u16` (2 bytes) -- 6000 = 60%
- `treasury_bps: u16` (2 bytes) -- 2000 = 20%
- `burn_bps: u16` (2 bytes) -- 1000 = 10%
- `maintenance_bps: u16` (2 bytes) -- 1000 = 10%
- `treasury_address: Pubkey` (32 bytes) -- where 20% treasury reserve goes
- `maintenance_address: Pubkey` (32 bytes) -- where 10% maintenance goes
- `gsd_mint: Pubkey` (32 bytes) -- $GSD token mint for burn
- `usdc_mint: Pubkey` (32 bytes) -- USDC mint address
- `event_count: u32` (4 bytes) -- total revenue events recorded
- `min_revenue_threshold: u64` (8 bytes) -- minimum amount to trigger distribution
- Derive `AnchorSerialize, AnchorDeserialize, Clone, InitSpace`
- Total: 8 (discriminator) + 189 = 197 bytes

**revenue_event.rs** -- RevenueEvent per-event PDA (seeds: ["revenue_event", event_index.to_le_bytes()]):
- Define `RevenueStatus` enum: `Recorded, Distributing, Completed` (derive AnchorSerialize, AnchorDeserialize, Clone, Copy, PartialEq, Eq, InitSpace)
- Define `RevenueToken` enum: `Sol, Usdc` (same derives)
- RevenueEvent struct:
  - `event_index: u32`, `bump: u8`, `vault_bump: u8` (bump for the developer_pool_vault PDA), `token: RevenueToken`, `total_amount: u64`
  - `developer_pool: u64`, `treasury_reserve: u64`, `burn_amount: u64`, `maintenance_amount: u64`
  - `status: RevenueStatus`, `recorded_at: i64`
  - `origin_signature: [u8; 64]` -- links to originating revenue tx
  - `total_contribution_score: u64` -- snapshotted at recording time (prevents manipulation)
  - `claimed_amount: u64` -- tracks how much of developer_pool has been claimed
  - `burn_signature: [u8; 64]` -- zeroed until burn executes (traceability for REVN-06)
  - `gsd_burned: u64` -- actual $GSD tokens burned
- Total: 8 + 218 = 226 bytes (added vault_bump: u8)

**revenue_claim.rs** -- RevenueClaim per-contributor per-event PDA (seeds: ["revenue_claim", claimant.key(), revenue_event.key()]):
- `claimant: Pubkey` (32 bytes)
- `revenue_event: Pubkey` (32 bytes)
- `bump: u8` (1 byte)
- `contribution_score: u64` (8 bytes) -- contributor's score at claim time
- `total_score: u64` (8 bytes) -- from RevenueEvent snapshot
- `amount: u64` (8 bytes) -- amount claimed
- `claimed_at: i64` (8 bytes)
- Total: 8 + 97 = 105 bytes

**revenue_vault.rs** -- RevenueVault marker account (no state needed, just a PDA for holding SOL):
- This is a system account PDA (seeds: ["revenue_vault", event_index.to_le_bytes()]) that holds the developer pool SOL/USDC for a given revenue event.
- It does NOT need an Anchor `#[account]` struct since it is a plain SystemAccount PDA used as a SOL vault.
- However, create a constants file for the seed: `pub const REVENUE_VAULT_SEED: &[u8] = b"revenue_vault";`
- For USDC: the vault is an Associated Token Account (ATA) derived from this PDA, which the program signs for via CPI.
- The PDA bump is discovered at runtime via `find_program_address`.

**Update state/mod.rs**: Add `pub mod revenue_config; pub mod revenue_event; pub mod revenue_claim; pub mod revenue_vault;` and corresponding `pub use` lines.

**Update errors.rs**: Add a new `RevenueError` enum (following GovernanceError pattern for domain separation):
- `InvalidSplitRatios` -- "Split ratios must sum to 10000 basis points"
- `BelowMinimumThreshold` -- "Revenue amount below minimum threshold"
- `EventNotRecorded` -- "Revenue event not in Recorded status"
- `EventAlreadyCompleted` -- "Revenue event already completed"
- `NoContributionScore` -- "Contributor has no contribution score"
- `AlreadyClaimed` -- "Revenue share already claimed for this event"
- `ClaimOverflow` -- "Claim calculation overflow"
- `DivisionByZero` -- "Total contribution score is zero"
- `InsufficientEscrowBalance` -- "Escrow balance insufficient for claim"
- `UnauthorizedBurnAuthority` -- "Not authorized to execute burn"
- `BurnAlreadyExecuted` -- "Burn already executed for this event"
  </action>
  <verify>Run `cd programs/gsd-hub && cargo check` -- should compile with no errors. All new state structs should derive InitSpace correctly.</verify>
  <done>Three revenue state files and revenue_vault seed constant compile, RevenueError enum has 11 error codes, state/mod.rs exports all new types</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript revenue types, PDA helpers, and Prisma models</name>
  <files>
    packages/types/src/revenue.ts
    packages/types/src/index.ts
    packages/utils/src/revenue-pda.ts
    packages/utils/src/index.ts
    apps/web/prisma/schema.prisma
  </files>
  <action>
**packages/types/src/revenue.ts** -- TypeScript revenue types (follow governance.ts pattern with lowercase string union enums):
- `RevenueStatus = 'recorded' | 'distributing' | 'completed'`
- `RevenueToken = 'sol' | 'usdc'`
- `RevenueEventInfo` interface: eventIndex (number), token (RevenueToken), totalAmount (string -- BigInt serialized), developerPool (string), treasuryReserve (string), burnAmount (string), maintenanceAmount (string), status (RevenueStatus), originSignature (string), totalContributionScore (string), claimedAmount (string), burnSignature (string | null), gsdBurned (string), recordedAt (string -- ISO date), onChainAddress (string)
- `RevenueClaimInfo` interface: claimantWallet (string), revenueEventId (string), contributionScore (string), totalScore (string), amount (string), claimedAt (string), transactionSignature (string)
- `RevenueConfigInfo` interface: admin (string), developerBps (number), treasuryBps (number), burnBps (number), maintenanceBps (number), treasuryAddress (string), maintenanceAddress (string), gsdMint (string), usdcMint (string), eventCount (number), minRevenueThreshold (string)
- `RevenueSummary` interface: totalRevenue (string), totalDistributed (string), totalBurned (string), totalGsdBurned (string), eventCount (number)

**packages/types/src/index.ts** -- Add `export * from './revenue'` (no .js extension, matching existing pattern from 02-05 decision).

**packages/utils/src/revenue-pda.ts** -- PDA derivation functions (follow governance-pda.ts pattern):
- Import `PublicKey` from `@solana/web3.js`
- Export constants: `REVENUE_CONFIG_SEED = "revenue_config"`, `REVENUE_EVENT_SEED = "revenue_event"`, `REVENUE_CLAIM_SEED = "revenue_claim"`
- `getRevenueConfigPDA(programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from(REVENUE_CONFIG_SEED)]
- `getRevenueEventPDA(eventIndex: number, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from(REVENUE_EVENT_SEED), u32 LE buffer of eventIndex] (use `buf.writeUInt32LE(eventIndex)` pattern)
- `getRevenueClaimPDA(claimant: PublicKey, revenueEvent: PublicKey, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from(REVENUE_CLAIM_SEED), claimant.toBuffer(), revenueEvent.toBuffer()]
- `REVENUE_VAULT_SEED = "revenue_vault"`
- `getRevenueVaultPDA(eventIndex: number, programId: PublicKey): [PublicKey, number]` -- seeds: [Buffer.from(REVENUE_VAULT_SEED), u32 LE buffer of eventIndex]

**packages/utils/src/index.ts** -- Add `export * from './revenue-pda'` (no .js extension).

**apps/web/prisma/schema.prisma** -- Add two new models at end of file:
```prisma
model RevenueEvent {
  id                      String   @id @default(cuid())
  eventIndex              Int      @unique
  onChainAddress          String   @unique
  token                   String   // "sol" or "usdc"
  totalAmount             BigInt
  developerPool           BigInt
  treasuryReserve         BigInt
  burnAmount              BigInt
  maintenanceAmount       BigInt
  status                  String   @default("recorded")
  originSignature         String   @unique
  totalContributionScore  BigInt
  claimedAmount           BigInt   @default(0)
  burnSignature           String?
  gsdBurned               BigInt   @default(0)
  recordedAt              DateTime
  createdAt               DateTime @default(now())

  claims                  RevenueClaim[]

  @@index([status])
  @@index([recordedAt])
}

model RevenueClaim {
  id                   String   @id @default(cuid())
  revenueEventId       String
  claimantWallet       String
  contributionScore    BigInt
  totalScore           BigInt
  amount               BigInt
  transactionSignature String   @unique
  claimedAt            DateTime

  revenueEvent         RevenueEvent @relation(fields: [revenueEventId], references: [id])

  @@unique([revenueEventId, claimantWallet])
  @@index([claimantWallet])
}
```

Also add a `PendingRevenue` model for detected treasury inflows awaiting admin review:
```prisma
model PendingRevenue {
  id                String   @id @default(cuid())
  transactionSignature String @unique
  token             String   // "sol" or "usdc"
  amount            BigInt
  fromAddress       String?
  detectedAt        DateTime @default(now())
  status            String   @default("pending") // "pending", "approved", "rejected", "processed"
  processedEventId  String?  // links to RevenueEvent.id once processed
  reviewedAt        DateTime?
  reviewNote        String?

  @@index([status])
  @@index([detectedAt])
}
```

BigInt columns follow the convention from governance models (e.g., Vote.weight, Idea.yesWeight). The `@@unique([revenueEventId, claimantWallet])` prevents double-claim at the database level mirroring the on-chain PDA uniqueness. The `PendingRevenue` model stores detected treasury inflows for admin review before triggering distribution (REVN-01 detection flow).
  </action>
  <verify>Run `npx tsc --noEmit` in packages/types and packages/utils to verify TypeScript compiles. Run `npx prisma validate` in apps/web to verify Prisma schema.</verify>
  <done>Revenue types exported from @gsd/types, PDA helpers (including getRevenueVaultPDA) exported from @gsd/utils, Prisma schema validates with RevenueEvent, RevenueClaim, and PendingRevenue models</done>
</task>

</tasks>

<verification>
1. `cd programs/gsd-hub && cargo check` passes
2. `cd packages/types && npx tsc --noEmit` passes
3. `cd packages/utils && npx tsc --noEmit` passes
4. `cd apps/web && npx prisma validate` passes
5. State structs match byte sizes documented in research
6. PDA seeds match between Rust and TypeScript
</verification>

<success_criteria>
- All 3 Rust state structs compile with InitSpace derive
- RevenueError enum has 11 error codes
- TypeScript types export cleanly from @gsd/types
- PDA derivation functions use correct seeds matching Rust
- Prisma schema validates with new RevenueEvent, RevenueClaim, and PendingRevenue models
- No existing code broken
</success_criteria>

<output>
After completion, create `.planning/phases/04-revenue-mechanics/04-01-SUMMARY.md`
</output>
