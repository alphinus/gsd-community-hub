generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  displayName   String?  @db.VarChar(50)
  bio           String?  @db.VarChar(500)
  avatarUrl     String?
  githubUrl     String?
  twitterUrl    String?
  websiteUrl    String?
  profileHash   String?
  onChainPda    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contributions Contribution[]

  @@index([walletAddress])
}

model Contribution {
  id                   String   @id @default(cuid())
  walletAddress        String
  taskRef              String
  verificationScore    Int
  contentHash          String
  leafHash             String
  leafIndex            Int
  treeAddress          String
  transactionSignature String   @unique
  description          String?
  createdAt            DateTime @default(now())

  user User @relation(fields: [walletAddress], references: [walletAddress])

  @@index([walletAddress])
  @@index([treeAddress, leafIndex])
}

model ProgramUpgrade {
  id                   String   @id @default(cuid())
  programId            String
  version              String
  description          String
  signers              String[]
  transactionSignature String
  multisigAddress      String
  createdAt            DateTime @default(now())
}

model IdeaRound {
  id              String   @id @default(cuid())
  roundIndex      Int      @unique
  onChainAddress  String   @unique
  title           String   @db.VarChar(200)
  description     String   @db.Text
  contentHash     String
  status          String   @default("open")
  submissionStart DateTime
  submissionEnd   DateTime
  votingEnd       DateTime
  ideaCount       Int      @default(0)
  quorumType      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ideas           Idea[]

  @@index([status])
  @@index([submissionEnd])
  @@index([votingEnd])
}

model Idea {
  id                   String   @id @default(cuid())
  ideaIndex            Int
  onChainAddress       String   @unique
  roundId              String
  authorWallet         String
  title                String   @db.VarChar(200)
  description          String   @db.Text
  contentHash          String
  status               String   @default("submitted")
  yesWeight            BigInt   @default(0)
  noWeight             BigInt   @default(0)
  abstainWeight        BigInt   @default(0)
  voterCount           Int      @default(0)
  transactionSignature String   @unique
  submittedAt          DateTime @default(now())

  round                IdeaRound @relation(fields: [roundId], references: [id])
  votes                Vote[]

  @@index([roundId])
  @@index([authorWallet])
}

model Vote {
  id                   String   @id @default(cuid())
  onChainAddress       String   @unique
  ideaId               String
  voterWallet          String
  vote                 String
  weight               BigInt
  transactionSignature String   @unique
  votedAt              DateTime

  idea                 Idea @relation(fields: [ideaId], references: [id])

  @@unique([ideaId, voterWallet])
  @@index([voterWallet])
}

model VoteDeposit {
  id              String   @id @default(cuid())
  walletAddress   String   @unique
  depositedAmount BigInt
  depositTimestamp DateTime
  eligibleAt      DateTime
  activeVotes     Int      @default(0)
  updatedAt       DateTime @updatedAt

  @@index([walletAddress])
}

model RevenueEvent {
  id                      String   @id @default(cuid())
  eventIndex              Int      @unique
  onChainAddress          String   @unique
  token                   String   // "sol" or "usdc"
  totalAmount             BigInt
  developerPool           BigInt
  treasuryReserve         BigInt
  burnAmount              BigInt
  maintenanceAmount       BigInt
  status                  String   @default("recorded")
  originSignature         String   @unique
  totalContributionScore  BigInt
  claimedAmount           BigInt   @default(0)
  burnSignature           String?
  gsdBurned               BigInt   @default(0)
  recordedAt              DateTime
  createdAt               DateTime @default(now())

  claims                  RevenueClaim[]

  @@index([status])
  @@index([recordedAt])
}

model RevenueClaim {
  id                   String   @id @default(cuid())
  revenueEventId       String
  claimantWallet       String
  contributionScore    BigInt
  totalScore           BigInt
  amount               BigInt
  transactionSignature String   @unique
  claimedAt            DateTime

  revenueEvent         RevenueEvent @relation(fields: [revenueEventId], references: [id])

  @@unique([revenueEventId, claimantWallet])
  @@index([claimantWallet])
}

model PendingRevenue {
  id                   String    @id @default(cuid())
  transactionSignature String    @unique
  token                String    // "sol" or "usdc"
  amount               BigInt
  fromAddress          String?
  detectedAt           DateTime  @default(now())
  status               String    @default("pending") // "pending", "approved", "rejected", "processed"
  processedEventId     String?   // links to RevenueEvent.id once processed
  reviewedAt           DateTime?
  reviewNote           String?

  @@index([status])
  @@index([detectedAt])
}
